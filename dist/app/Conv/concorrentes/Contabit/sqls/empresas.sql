WITH UltimoEmpDetalhe AS (
    SELECT ed.*,
           ROW_NUMBER() OVER (PARTITION BY ed.idempresa ORDER BY ed.dtinicio DESC) AS rn
    FROM dbo.tbempresadetalhe ed
),
UltimoContador AS (
    SELECT c.*,
           ROW_NUMBER() OVER (PARTITION BY c.idempresa ORDER BY c.idcontador DESC) AS rn
    FROM dbo.tbcontador c
),
UltimoRepresentante AS (
    SELECT r.*,
           ROW_NUMBER() OVER (PARTITION BY r.idempresa ORDER BY r.idrepresentante ASC) AS rn
    FROM dbo.tbrepresentante r
    WHERE r.fltipo = 1
),
UltimoCargoDetalhe AS (
    SELECT cd.*,
           ROW_NUMBER() OVER (PARTITION BY cd.idempresa, cd.idcargo ORDER BY cd.dtinicio DESC) AS rn
    FROM dbo.tbcargodetalhe cd
)
SELECT 
    e.idempresa,
    ed.dtinicio,
    ed.nmempresa,
    ed.flclasesocial,
    ed.cdnaturezajuridica,
    e.fltipoempresa,
    e.nrcnpjcpf,
    e.flmatriz,
    e.idmatriz,
    e.nriestadual,
    e.nrimunicipal,
    e.nrcno,
    e.dtinicioatividade,
    e.mascaracladpto,
    e.dtclientedesde,
    e.dtclienteate,
    e.idrateiofolha,
    e.idrota,
    e.cdtce,
    e.idsindicato,
    e.ddinicioponto,
    e.flpat,
    e.nrregistro,
    e.nmorgaoregistro,
    e.dtregistro,
    e.nmfantasia,
    e.fllogradouro,
    e.dslogradouro,
    e.dscplogradouro,
    e.nrlogradouro,
    e.nmbairro,
    e.nmcidade,
    e.cdibgecidade,
    e.nrcep,
    e.fluf,
    e.nrtelefonefixo,
    e.nrtelefonecelular,
    e.nmhomepage,
    e.nmemail,
    e.dsatividade,
    e.dtinicioesocial,
    e.fltpambesocial,
    e.flpisfolha,
    e.flcaged,
    e.flcestabasica,
    e.flgeralctofolha,
    e.hashcode,
    e.idusuario,
    e.nrcertificadodigital,
    e.flstatusesocial,
    e.flstatusesocials1000,
    e.flstatusesocials1005,
    e.idempresaimportarubricas,
    e.ammudancaregimecaixa,
    e.idpessoaprocurador,
    e.flexibeavisos,
    e.flstatusreinfr1000,
    e.dtiniciofechafiscal,
    e.dssoftwareinternoempresa,
    e.flpossuinire,
    e.dtconversaoscse,
    e.nriestadualst,
    e.dtinicioverificanfs,
    e.flbloqueiaempresa,
    e.cdestabelecimentoarquivomargem,
    e.flcontabit,
    e.cdempresasistemaanterior,
    e.cdestabsistemaanterior,
    e.idautorizacaomodelo,
    e.idpessoaprevcomplementar,
    c.idpessoa AS contador,
    p.nmpessoa AS rlg_nmpessoa,
    p.nrcnpjcpf AS rlg_nrcnpjcpf,
    p.nriestadual AS rlg_nriestadual,
    p.nrimunicipal AS rlg_nrimunicipal,
    p.fllogradouro AS rlg_fllogradouro,
    p.dslogradouro AS rlg_dslogradouro,
    p.dscplogradouro AS rlg_dscplogradouro,
    p.nrlogradouro AS rlg_nrlogradouro,
    p.nmbairro AS rlg_nmbairro,
    p.nmcidade AS rlg_nmcidade,
    p.cdibgecidade AS rlg_cdibgecidade,
    p.nrcep AS rlg_nrcep,
    p.fluf AS rlg_fluf,
    p.cdibgepais AS rlg_cdibgepais,
    p.nrtelefonefixo AS rlg_nrtelefonefixo,
    p.nrtelefonecelular AS rlg_nrtelefonecelular,
    p.cdnaturezajuridica AS rlg_cdnaturezajuridica,
    p.nmhomepage AS rlg_nmhomepage,
    p.nmemail AS rlg_nmemail,
    p.idintegracao AS rlg_idintegracao,
    p.nrcrc AS rlg_nrcrc,
    p.nmorgaoemissorcrc AS rlg_nmorgaoemissorcrc,
    p.dtexpedicaocrc AS rlg_dtexpedicaocrc,
    p.flufcrc AS rlg_flufcrc,
    p.nrregularidadecrc AS rlg_nrregularidadecrc,
    p.dtregularidadecrc AS rlg_dtregularidadecrc,
    p.nrcertificadodigital AS rlg_nrcertificadodigital,
    p.nrresponsavelcno AS rlg_nrresponsavelcno,
    p.idpessoaceianterior AS rlg_idpessoaceianterior,
    p.nrpis AS rlg_nrpis,
    p.divencimento AS rlg_divencimento,
    p.fllogradourocobranca AS rlg_fllogradourocobranca,
    p.dslogradourocobranca AS rlg_dslogradourocobranca,
    p.dscplogradourocobranca AS rlg_dscplogradourocobranca,
    p.nrlogradourocobranca AS rlg_nrlogradourocobranca,
    p.nmbairrocobranca AS rlg_nmbairrocobranca,
    p.nmcidadecobranca AS rlg_nmcidadecobranca,
    p.cdibgecidadecobranca AS rlg_cdibgecidadecobranca,
    p.nrcepcobranca AS rlg_nrcepcobranca,
    p.flufcobranca AS rlg_flufcobranca,
    p.cdibgepaiscobranca AS rlg_cdibgepaiscobranca,
    p.nmemailcobranca AS rlg_nmemailcobranca,
    p.flenderecocobranca AS rlg_flenderecocobranca,
    p.flretencaopiscofins AS rlg_flretencaopiscofins,
    p.byassinatura AS rlg_byassinatura,
    p.flremessacobranca AS rlg_flremessacobranca,
    p.flcobrancaporemail AS rlg_flcobrancaporemail,
    p.flbloqueiaemailcobranca AS rlg_flbloqueiaemailcobranca,
    p.idescolaguarda AS rlg_idescolaguarda,
    p.nmcontato AS rlg_nmcontato,
    p.nrnif AS rlg_nrnif,
    p.flnif AS rlg_flnif,
    p.flclassificacao AS rlg_flclassificacao,
    p.dtnascimento AS rlg_dtnascimento,
    p.txdescontopgtovencimento AS rlg_txdescontopgtovencimento,
    p.nrrg AS rlg_nrrg,
    p.nmorgaoemissorrg AS rlg_nmorgaoemissorrg,
    p.dtexpedicaorg AS rlg_dtexpedicaorg,
    p.flufrg AS rlg_flufrg,
    p.nrcnh AS rlg_nrcnh,
    p.flufcnh AS rlg_flufcnh,
    p.dtexpedicaocnh AS rlg_dtexpedicaocnh,
    p.dtvalidadecnh AS rlg_dtvalidadecnh,
    p.dtprihabilitacao AS rlg_dtprihabilitacao,
    p.flcathabilitacao AS rlg_flcathabilitacao,
    p.dschavecontabit AS rlg_dschavecontabit,
    p.cdibgepaispgtoreinf AS rlg_cdibgepaispgtoreinf,
    p.flimuneisenta AS rlg_flimuneisenta,
    p.flformatribrendext AS rlg_flformatribrendext,
    p.fltipoinscricao AS rlg_fltipoinscricao,
    cd.dscargo AS rlg_dscargo
FROM UltimoEmpDetalhe ed
JOIN dbo.tbempresa e ON e.idempresa = ed.idempresa
LEFT JOIN UltimoContador c ON c.idempresa = e.idempresa AND c.rn = 1
LEFT JOIN UltimoRepresentante r ON r.idempresa = e.idempresa AND r.rn = 1
LEFT JOIN dbo.tbpessoa p ON p.idpessoa = r.idpessoa
LEFT JOIN UltimoCargoDetalhe cd ON cd.idempresa = r.idempresa AND cd.idcargo = r.idcargo AND cd.rn = 1
WHERE ed.rn = 1
ORDER BY e.idempresa