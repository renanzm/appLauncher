CREATE OR ALTER PROCEDURE FOLHA_MENSAL 
RETURNS (
    ABREV VARCHAR(8),
    CODFUNC VARCHAR(10),
    COMPETENCIA DATE,
    TOMADOR VARCHAR(3),
    CODEVENT VARCHAR(4),
    REFERENCIA DOUBLE PRECISION,
    VALOR DOUBLE PRECISION)
AS
DECLARE VARIABLE SQL_CMD VARCHAR(500);
DECLARE VARIABLE V_ABREV VARCHAR(8);
DECLARE VARIABLE V_CODIGO VARCHAR(10);
DECLARE VARIABLE V_TOMADOR VARCHAR(3);
DECLARE VARIABLE V_CODEVENT VARCHAR(4);
DECLARE VARIABLE V_REFERENCIA DOUBLE PRECISION;
DECLARE VARIABLE V_VALOR DOUBLE PRECISION;
DECLARE TABELA_CALCULO CURSOR FOR (SELECT R.RDB$RELATION_NAME AS TABELA,
       SUBSTRING(R.RDB$RELATION_NAME FROM 3 FOR 4) AS ANO,
       SUBSTRING(R.RDB$RELATION_NAME FROM 7 FOR 2) AS MES
  FROM RDB$RELATIONS R
 WHERE R.RDB$RELATION_NAME LIKE 'HF%'
   AND R.RDB$SYSTEM_FLAG = 0
 ORDER BY R.RDB$RELATION_NAME);
BEGIN
  OPEN TABELA_CALCULO;
  WHILE (TRUE) DO BEGIN
    FETCH TABELA_CALCULO;
    IF (ROW_COUNT = 0) THEN LEAVE;
    SQL_CMD = 'SELECT ABREV, CODIGO, TOMADOR, CODEVENT, REFERENCIA, VALOR FROM ' || :TABELA_CALCULO.TABELA || ' WHERE MODO = ''M'';';

    FOR EXECUTE STATEMENT :SQL_CMD
      INTO :V_ABREV, :V_CODIGO, :V_TOMADOR, :V_CODEVENT, :V_REFERENCIA, :V_VALOR
    DO BEGIN
      ABREV = V_ABREV;
      CODFUNC = V_CODIGO;
      COMPETENCIA = CAST(:TABELA_CALCULO.ANO || '-' || :TABELA_CALCULO.MES || '-01' AS DATE);
      TOMADOR = V_TOMADOR;
      CODEVENT = V_CODEVENT;
      REFERENCIA = V_REFERENCIA;
      VALOR = V_VALOR;
      SUSPEND;
    END
  END
  CLOSE TABELA_CALCULO;
END
