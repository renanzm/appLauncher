SELECT  ES.CD_EMPRESA AS CODI_EMP,
        ES.CD_EMPRESA AS CODIGO,
		ES.RECIBO_ESOCIAL,
		CAST(ES.CD_EMPRESA AS CHAR(06)) AS CODIGO_ESOCIAL,
		'1000' AS EVENTO,
		'' AS DATA_TIPO_RESCISAO
FROM EVENTOTRANSMISSAOESOCIAL AS ES
WHERE ES.RECIBO_ESOCIAL <> '' AND 
      SUBSTRING(ES.RECIBO_ESOCIAL, 1, 4) = '1.1.' AND
	  ES.CD_TIPO_EVENTO IN ('S-1000') AND
	  CAST(CD_EMPRESA as CHAR(30)) IS NOT NULL

UNION ALL

SELECT  ES.CD_EMPRESA AS CODI_EMP,
        CAST(EV.CODIGO as CHAR(30)) AS CODIGO,
		ES.RECIBO_ESOCIAL,
		COALESCE((SELECT MAX(FUNCAO.ID_ESOCIAL) 
				  FROM FUNCAO 
				 WHERE FUNCAO.ENTERPRISE_ID = ES.CD_EMPRESA 
				   AND FUNCAO.CD_FUNCAO = EV.CODIGO),EV.CODIGO) AS CODIGO_ESOCIAL,
		'1030' AS EVENTO,
		'' AS DATA_TIPO_RESCISAO
FROM EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN CRHCONTROLETRANSMISSAOESOCIALEVENTOS1030 AS EV
ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
WHERE ES.RECIBO_ESOCIAL <> '' AND 
      SUBSTRING(ES.RECIBO_ESOCIAL, 1, 4) = '1.1.' AND
	  ES.CD_TIPO_EVENTO IN ('S-1030') AND
	  CAST(EV.CODIGO as CHAR(30)) IS NOT NULL
	  
UNION ALL

SELECT  ES.CD_EMPRESA AS CODI_EMP,
        CAST(EV.CODIGO as CHAR(30)) AS CODIGO,
		ES.RECIBO_ESOCIAL,
		COALESCE((SELECT MAX(FUNCIONARIO.MATRICULA_ESOCIAL) 
				  FROM FUNCIONARIO 
				 WHERE FUNCIONARIO.CD_EMPRESA = ES.CD_EMPRESA 
				   AND FUNCIONARIO.cd_funcionario = EV.CODIGO),EV.CODIGO) AS CODIGO_ESOCIAL,
		'2200' AS EVENTO,
		'' AS DATA_TIPO_RESCISAO
FROM EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN CRHCONTROLETRANSMISSAOESOCIALEVENTOS2200 AS EV
ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
WHERE ES.RECIBO_ESOCIAL <> '' AND 
      SUBSTRING(ES.RECIBO_ESOCIAL, 1, 4) = '1.1.' AND
	  ES.CD_TIPO_EVENTO IN ('S-2200') AND
	  CAST(EV.CODIGO as CHAR(30)) IS NOT NULL
	  AND EV.CODIGO not like '%ET%'
      AND EV.CODIGO not like '%81c%'
	 
UNION ALL

SELECT  ES.CD_EMPRESA AS CODI_EMP,
        (SUBSTRING_INDEX(EV.CODIGO,'|',1)) AS CODIGO,
		ES.RECIBO_ESOCIAL,
		(SUBSTRING_INDEX(EV.CODIGO,'|',1)) AS CODIGO_ESOCIAL,
		'2205' AS EVENTO,
		DATE_FORMAT(EV.DT_REFERENCIA,'%Y-%m-%d') AS DATA_TIPO_RESCISAO
FROM EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN CRHCONTROLETRANSMISSAOESOCIALEVENTOS2205 AS EV
ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
WHERE ES.RECIBO_ESOCIAL <> '' AND 
      SUBSTRING(ES.RECIBO_ESOCIAL, 1, 4) = '1.1.' AND
	  ES.CD_TIPO_EVENTO IN ('S-2205') AND
	  (SUBSTRING_INDEX(EV.CODIGO,'|',1)) IS NOT NULL
	  AND EV.CODIGO not like '%ET%'
      AND EV.CODIGO not like '%81c%'
	  
UNION ALL

SELECT  ES.CD_EMPRESA AS CODI_EMP,
        (SUBSTRING_INDEX(EV.CODIGO,'|',1)) AS CODIGO,
		ES.RECIBO_ESOCIAL,
		(SUBSTRING_INDEX(EV.CODIGO,'|',1)) AS CODIGO_ESOCIAL,
		'2206' AS EVENTO,
		DATE_FORMAT(EV.DT_REFERENCIA,'%Y-%m-%d') AS DATA_TIPO_RESCISAO
FROM EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN CRHCONTROLETRANSMISSAOESOCIALEVENTOS2206 AS EV
ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
WHERE ES.RECIBO_ESOCIAL <> '' AND 
      SUBSTRING(ES.RECIBO_ESOCIAL, 1, 4) = '1.1.' AND
	  ES.CD_TIPO_EVENTO IN ('S-2206') AND
	  (SUBSTRING_INDEX(EV.CODIGO,'|',1)) IS NOT NULL
	  AND EV.CODIGO not like '%ET%'
      AND EV.CODIGO not like '%81c%'
	  
UNION ALL

SELECT  ES.CD_EMPRESA AS CODI_EMP,
        CAST(EV.CODIGO AS CHAR(30)) AS CODIGO,
        ES.RECIBO_ESOCIAL,
        COALESCE(DIR.MATRICULA_ESOCIAL, FUN.MATRICULA_ESOCIAL, EV.CODIGO) AS CODIGO_ESOCIAL,
        '2300' AS EVENTO,
        '' AS DATA_TIPO_RESCISAO
FROM EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN CRHCONTROLETRANSMISSAOESOCIALEVENTOS2300 AS EV
    ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
LEFT JOIN DIRETOR AS DIR
    ON ES.CD_EMPRESA = DIR.CD_EMPRESA
    AND DIR.CD_DIRETOR = EV.CODIGO
LEFT JOIN FUNCIONARIO AS FUN
    ON ES.CD_EMPRESA = FUN.CD_EMPRESA
    AND FUN.CD_FUNCIONARIO = EV.CODIGO
WHERE ES.RECIBO_ESOCIAL <> '' 
    AND SUBSTRING(ES.RECIBO_ESOCIAL, 1, 4) = '1.1.'
    AND ES.CD_TIPO_EVENTO IN ('S-2300')
    AND CAST(EV.CODIGO AS CHAR(30)) IS NOT NULL
    AND EV.CODIGO NOT LIKE '%ET%'
    AND EV.CODIGO NOT LIKE '%81c%'

	  
UNION ALL

SELECT  ES.CD_EMPRESA AS CODI_EMP,
        CAST(EV.CODIGO as CHAR(30)) AS CODIGO,
		ES.RECIBO_ESOCIAL,
		CAST(EV.CODIGO as CHAR(30)) AS CODIGO_ESOCIAL,
		'2306' AS EVENTO,
		DATE_FORMAT(EV.DT_REFERENCIA,'%Y-%m-%d') AS DATA_TIPO_RESCISAO
FROM EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN CRHCONTROLETRANSMISSAOESOCIALEVENTOS2306 AS EV
ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
WHERE ES.RECIBO_ESOCIAL <> '' AND 
      SUBSTRING(ES.RECIBO_ESOCIAL, 1, 4) = '1.1.' AND
	  ES.CD_TIPO_EVENTO IN ('S-2306') AND
	  CAST(EV.CODIGO as CHAR(30)) IS NOT NULL
	  AND EV.CODIGO not like '%ET%'
      AND EV.CODIGO not like '%81c%'

UNION ALL

SELECT  ES.CD_EMPRESA AS CODI_EMP,
        CAST(EV.CODIGO as CHAR(30)) AS CODIGO,
		ES.RECIBO_ESOCIAL,
		COALESCE((SELECT MAX(TOMADOR.ID_ESOCIAL) 
				  FROM TOMADOR 
				 WHERE TOMADOR.cd_empresa = ES.cd_empresa 
				   AND CAST(TOMADOR.cd_tomador AS CHAR(30)) = CAST(EV.CODIGO AS CHAR(30))),EV.CODIGO) AS CODIGO_ESOCIAL,
		'1005' AS EVENTO,
		DATE_FORMAT(EV.DT_REFERENCIA,'%Y-%m-%d') AS DATA_TIPO_RESCISAO
FROM EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN CRHCONTROLETRANSMISSAOESOCIALEVENTOS1005 AS EV
ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
WHERE ES.RECIBO_ESOCIAL <> '' AND 
      SUBSTRING(ES.RECIBO_ESOCIAL, 1, 4) = '1.1.' AND
	  ES.CD_TIPO_EVENTO IN ('S-1005') AND
	  CAST(EV.CODIGO as CHAR(30)) IS NOT NULL

UNION ALL

SELECT  ES.CD_EMPRESA AS CODI_EMP,
        CAST(EV.CODIGO as CHAR(30)) AS CODIGO,
		ES.RECIBO_ESOCIAL,
		COALESCE((SELECT MAX(TOMADOR.ID_ESOCIAL) 
				  FROM TOMADOR 
				 WHERE TOMADOR.cd_empresa = ES.cd_empresa 
				   AND CAST(TOMADOR.cd_tomador AS CHAR(30)) = CAST(EV.CODIGO AS CHAR(30))),EV.CODIGO) AS CODIGO_ESOCIAL,
		'1020' AS EVENTO,
		DATE_FORMAT(EV.DT_REFERENCIA,'%Y-%m-%d') AS DATA_TIPO_RESCISAO
FROM EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN CRHCONTROLETRANSMISSAOESOCIALEVENTOS1020 AS EV
ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
WHERE ES.RECIBO_ESOCIAL <> '' AND 
      SUBSTRING(ES.RECIBO_ESOCIAL, 1, 4) = '1.1.' AND
	  ES.CD_TIPO_EVENTO IN ('S-1020') AND
	  CAST(EV.CODIGO as CHAR(30)) IS NOT NULL

UNION ALL

SELECT 
    ES.CD_EMPRESA AS CODI_EMP,
    CASE
        WHEN INSTR(EV.CODIGO, '|') > 0 THEN LEFT(EV.CODIGO, INSTR(EV.CODIGO, '|') - 1)
        ELSE EV.CODIGO
    END AS CODIGO,
    ES.RECIBO_ESOCIAL,
    CASE
        WHEN INSTR(EV.CODIGO, '|') > 0 THEN LEFT(EV.CODIGO, INSTR(EV.CODIGO, '|') - 1)
        ELSE EV.CODIGO
    END AS CODIGO_ESOCIAL,
    '2230' AS EVENTO,
    CASE
        WHEN INSTR(EV.CODIGO, '|') > 0 THEN RIGHT(EV.CODIGO, LENGTH(EV.CODIGO) - INSTR(EV.CODIGO, '|'))
        ELSE NULL
    END AS DATA_TIPO_RESCISAO
FROM EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN CRHCONTROLETRANSMISSAOESOCIALEVENTOS2230 AS EV
    ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
WHERE CD_TIPO_EVENTO IN ('S-2230')
    AND ES.RECIBO_ESOCIAL <> '' 
    AND SUBSTRING(ES.RECIBO_ESOCIAL, 1, 4) = '1.1.'
    AND CAST(EV.CODIGO AS CHAR(30)) IS NOT NULL


ORDER BY 1,5,2 DESC, 3, 4, 6;