DECLARE @retorno int
DECLARE @query VARCHAR(8000)
DECLARE @query_2 VARCHAR(8000)
SET @query = 'SELECT CRDESTABELECIMENTO.CD_EMPRESA,
CRDESTABELECIMENTO.RAZAO,
CRDESTABELECIMENTO.FANTASIA,
CRDESTABELECIMENTO.ENDERECO,
CRDESTABELECIMENTO.NUMERO,
CRDESTABELECIMENTO.COMPLEMENTO,
CRDESTABELECIMENTO.BAIRRO,
CRDESTABELECIMENTO.CIDADE,
CRDESTABELECIMENTO.CEP,
CRDESTABELECIMENTO.UF,
CRDESTABELECIMENTO.CD_MUNICIPIO,
COALESCE((SELECT MUNICIPIOG.CD_MUNICIPIO_CONCLA 
            FROM EBS_CORDILHEIRA.DBO.MUNICIPIOG 
           WHERE MUNICIPIOG.CD_MUNICIPIO = CRDESTABELECIMENTO.CD_MUNICIPIO 
		     AND MUNICIPIOG.ESTADO = CRDESTABELECIMENTO.UF), (SELECT MAX(MUNICIPIOCGW.CD_MUNICIPIO_IBGE )
															    FROM EBS_Cordilheira.DBO.MUNICIPIOCGW 
															   WHERE MUNICIPIOCGW.CD_MUNICIPIO_IBGE = CRDESTABELECIMENTO.CD_MUNICIPIO 
																 AND MUNICIPIOCGW.UF = CRDESTABELECIMENTO.UF)) AS CODIGO_IBGE,
CRDESTABELECIMENTO.DDD_TELEFONE,
CRDESTABELECIMENTO.TELEFONE,
CRDESTABELECIMENTO.DDD_TELEFONE2,
CRDESTABELECIMENTO.REGISTRO,
CRDESTABELECIMENTO.DDD_FAX,
CRDESTABELECIMENTO.FAX,
CRDESTABELECIMENTO.EMAIL,
CRDESTABELECIMENTO.SITE,
CRDESTABELECIMENTO.NATUREZA_JURIDICA,
CRDESTABELECIMENTO.CNPJ_CPF,
CRDESTABELECIMENTO.INSCRICAO_EST,
CRDESTABELECIMENTO.INSCRICAO_MUN,
CRDESTABELECIMENTO.CODIGO_CEI,
CRDESTABELECIMENTO.CNAE,
CRDESTABELECIMENTO.LOCAL_REGISTRO,
CRDESTABELECIMENTO.DATA_REGISTRO,
CRDESTABELECIMENTO.NOME_TITULAR,
CRDESTABELECIMENTO.DENOM_TITULAR,
CRDESTABELECIMENTO.CPF_TITULAR,
CRDESTABELECIMENTO.RG_TITULAR,
CRDESTABELECIMENTO.CIDADE_TITULAR,
CRDESTABELECIMENTO.ENDERECO_TITULAR,
CRDESTABELECIMENTO.NUMERO_TITULAR,
CRDESTABELECIMENTO.BAIRRO_TITULAR,
CRDESTABELECIMENTO.COMPLEMENTO_TITULAR,
CRDESTABELECIMENTO.UF_TITULAR,
CRDESTABELECIMENTO.CEP_TITULAR,
CRDESTABELECIMENTO.DDD_TELEFONE_TITULAR,
CRDESTABELECIMENTO.TELEFONE_TITULAR,
CRDESTABELECIMENTO.EMAIL_TITULAR,
COALESCE(CRDESTABELECIMENTO.DT_INICIO_ATIVIDADE, COALESCE((SELECT MIN(FUNFUNCIONAL.DT_ADMISSAO) 
                                                         FROM EBS_CORDILHEIRA.DBO.FUNFUNCIONAL
												        WHERE FUNFUNCIONAL.CD_EMPRESA = CRDESTABELECIMENTO.CD_EMPRESA), GETDATE()) ) AS DT_INICIO_ATIVIDADE,
(SELECT MAX(CRDESTABELECIMENTOVIGENCIA.ESOCIAL_CAEPF) FROM EBS_CORDILHEIRA.DBO.CRDESTABELECIMENTOVIGENCIA WHERE CRDESTABELECIMENTOVIGENCIA.CD_EMPRESA = CRDESTABELECIMENTO.CD_EMPRESA) AS CAEPF,
CRDESTABELECIMENTO.STATUS,
CRDESTABELECIMENTO.ATIVIDADES,
(SELECT min(CRDEstabelecimentoParametro.tipo_logradouro) FROM EBS_CORDILHEIRA.DBO.CRDEstabelecimentoParametro WHERE CRDEstabelecimentoParametro.CD_EMPRESA = CRDESTABELECIMENTO.CD_EMPRESA) AS TIPO_LOGRADOURO,
CRDESTABELECIMENTO.CD_RESPONSAVEL_ESTABELECIMENTO

FROM EBS_CORDILHEIRA.DBO.CRDESTABELECIMENTO

WHERE TIPO_ESTABELECIMENTO = ''M''

ORDER BY CRDESTABELECIMENTO.CD_EMPRESA;'
SET @query_2 = 'SELECT CRDESTABELECIMENTO.CD_EMPRESA,
CRDESTABELECIMENTO.RAZAO,
CRDESTABELECIMENTO.FANTASIA,
CRDESTABELECIMENTO.ENDERECO,
CRDESTABELECIMENTO.NUMERO,
CRDESTABELECIMENTO.COMPLEMENTO,
CRDESTABELECIMENTO.BAIRRO,
CRDESTABELECIMENTO.CIDADE,
CRDESTABELECIMENTO.CEP,
CRDESTABELECIMENTO.UF,
CRDESTABELECIMENTO.CD_MUNICIPIO,
COALESCE((SELECT MUNICIPIOG.CD_MUNICIPIO_CONCLA 
            FROM EBS_CORDILHEIRA.DBO.MUNICIPIOG 
           WHERE MUNICIPIOG.CD_MUNICIPIO = CRDESTABELECIMENTO.CD_MUNICIPIO 
		     AND MUNICIPIOG.ESTADO = CRDESTABELECIMENTO.UF), (SELECT MAX(MUNICIPIOCGW.CD_MUNICIPIO_IBGE )
															    FROM EBS_Cordilheira.DBO.MUNICIPIOCGW 
															   WHERE MUNICIPIOCGW.CD_MUNICIPIO_IBGE = CRDESTABELECIMENTO.CD_MUNICIPIO  
																 AND MUNICIPIOCGW.UF = CRDESTABELECIMENTO.UF)) AS CODIGO_IBGE,
CRDESTABELECIMENTO.DDD_TELEFONE,
CRDESTABELECIMENTO.TELEFONE,
CRDESTABELECIMENTO.DDD_TELEFONE2,
CRDESTABELECIMENTO.REGISTRO,
CRDESTABELECIMENTO.DDD_FAX,
CRDESTABELECIMENTO.FAX,
CRDESTABELECIMENTO.EMAIL,
CRDESTABELECIMENTO.SITE,
CRDESTABELECIMENTO.NATUREZA_JURIDICA,
CRDESTABELECIMENTO.CNPJ_CPF,
CRDESTABELECIMENTO.INSCRICAO_EST,
CRDESTABELECIMENTO.INSCRICAO_MUN,
CRDESTABELECIMENTO.CODIGO_CEI,
CRDESTABELECIMENTO.CNAE,
CRDESTABELECIMENTO.LOCAL_REGISTRO,
CRDESTABELECIMENTO.DATA_REGISTRO,
CRDESTABELECIMENTO.NOME_TITULAR,
CRDESTABELECIMENTO.DENOM_TITULAR,
CRDESTABELECIMENTO.CPF_TITULAR,
CRDESTABELECIMENTO.RG_TITULAR,
CRDESTABELECIMENTO.CIDADE_TITULAR,
CRDESTABELECIMENTO.ENDERECO_TITULAR,
CRDESTABELECIMENTO.NUMERO_TITULAR,
CRDESTABELECIMENTO.BAIRRO_TITULAR,
CRDESTABELECIMENTO.COMPLEMENTO_TITULAR,
CRDESTABELECIMENTO.UF_TITULAR,
CRDESTABELECIMENTO.CEP_TITULAR,
CRDESTABELECIMENTO.DDD_TELEFONE_TITULAR,
CRDESTABELECIMENTO.TELEFONE_TITULAR,
CRDESTABELECIMENTO.EMAIL_TITULAR,
COALESCE(CRDESTABELECIMENTO.DT_INICIO_ATIVIDADE, COALESCE((SELECT MIN(FUNFUNCIONAL.DT_ADMISSAO) 
                                                         FROM EBS_CORDILHEIRA.DBO.FUNFUNCIONAL
												        WHERE FUNFUNCIONAL.CD_EMPRESA = CRDESTABELECIMENTO.CD_EMPRESA), GETDATE()) ) AS DT_INICIO_ATIVIDADE,
(SELECT MAX(CRDESTABELECIMENTOVIGENCIA.ESOCIAL_CAEPF) FROM EBS_CORDILHEIRA.DBO.CRDESTABELECIMENTOVIGENCIA WHERE CRDESTABELECIMENTOVIGENCIA.CD_EMPRESA = CRDESTABELECIMENTO.CD_EMPRESA) AS CAEPF,
CRDESTABELECIMENTO.STATUS,
CRDESTABELECIMENTO.ATIVIDADES,
(SELECT min(CRDEstabelecimentoParametro.tipo_logradouro) FROM EBS_CORDILHEIRA.DBO.CRDEstabelecimentoParametro WHERE CRDEstabelecimentoParametro.CD_EMPRESA = CRDESTABELECIMENTO.CD_EMPRESA) AS TIPO_LOGRADOURO,
CRDESTABELECIMENTO.CD_RESPONSAVEL_ESTABELECIMENTO

FROM EBS_CORDILHEIRA.DBO.CRDESTABELECIMENTO

WHERE TIPO_ESTABELECIMENTO = ''M''

ORDER BY CRDESTABELECIMENTO.CD_EMPRESA;'
SELECT @retorno = COUNT(COLUMN_NAME) FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'CRDESTABELECIMENTOVIGENCIA';
IF (@retorno > 0)
BEGIN
    exec (@query)
END
ELSE
BEGIN
	exec (@query_2)
END