SELECT 
DIRETOR.CD_EMPRESA,
DIRETOR.CD_DIRETOR,
DIRETOR.SITUACAO,
DIRETOR.NOME,
DIRETOR.CD_FILIAL,
DIRETOR.PIS,
DIRETOR.CPF,
DIRETOR.IDENTIDADE,
DIRETOR.ORGAO_IDENTIDADE,
DIRETOR.INSCRICAO_INSS,
DIRETOR.CARGO,
DIRETOR.ENDERECO,
DIRETOR.NR_ENDERECO,
DIRETOR.COMPL_ENDERECO,
DIRETOR.BAIRRO,
DIRETOR.CIDADE,
DIRETOR.ESTADO,
DIRETOR.CEP,
DIRETOR.CD_PAIS_ENDERECO,
DIRETOR.DDD_FONE,
DIRETOR.TELEFONE,
DIRETOR.CATEGORIA,
DIRETOR.DT_NASCIMENTO,
DIRETOR.DT_ADMISSAO,
RETIRADA.VL_PROLABORE,
DIRETOR.CBO,
DIRETOR.DEPARTAMENTO,
DIRETOR.CBO2002,
DIRETOR.OCORRENCIA,
DIRETOR.CD_CCUSTO,
DIRETOR.QUALIFICACAO,
DIRETOR.CD_TOMADOR,
DIRETOR.SEXO,
DIRETOR.ESTADO_CIVIL,
DIRETOR.NOME_PAI,
DIRETOR.NOME_MAE,
DIRETOR.CD_FUNCAO,
DIRETOR.CD_CATEGORIA_ESOCIAL,
DIRETOR.TIPO_LOGRADOURO,
DIRETOR.CD_MUNICIPIO_NASCIMENTO,
DIRETOR.CD_PAIS_NASCIMENTO,
DIRETOR.RACA,
DIRETOR.UF_IDENTIDADE,
DIRETOR.DT_EMISSAO_IDENTIDADE,
DIRETOR.EMAIL,
DIRETOR.ESTADO_NASCIMENTO,
DIRETOR.CD_NACIONALIDADE_PAIS,
DIRETOR.VL_FATOR_MULTIPLICACAO,
DIRETOR.MATRICULA_ESOCIAL,
DIRETOR.NR_CARTEIRA,
DIRETOR.SERIE_CARTEIRA,
DIRETOR.DV_SERIE_CARTEIRA,
DIRETOR.UF_CARTEIRA,
DIRETOR.DT_EMISSAO_CARTEIRA,
DIRETOR.NR_REG_PROF,
DIRETOR.ORGAO_REG_PROF,
DIRETOR.DT_EMISSAO_REG_PROF,
DIRETOR.DT_VCTO_REG_PROF,
DIRETOR.NR_TITULO,
DIRETOR.ZONA_TITULO,
DIRETOR.SECAO_TITULO,
DIRETOR.DT_EMISSAO_TITULO,
DIRETOR.NR_HABILITACAO,
DIRETOR.UF_HABILITACAO,
DIRETOR.CATEGORIA_HABILITACAO,
DIRETOR.DT_VCTO_HABILITACAO,
DIRETOR.DT_EMISSAO_HABILITACAO,
DIRETOR.DT_PRIMEIRA_HABILITACAO,
DIRETOR.ORGAO_EMISSOR_CNH,
DIRETOR.CD_BANCO,
DIRETOR.OPERACAO_BANCARIA,
DIRETOR.NR_AGENCIA_BANCARIA,
DIRETOR.DV_AGENCIA_BANCARIA,
DIRETOR.NR_CONTA_BANCARIA,
DIRETOR.DV_CONTA_BANCARIA,
DIRETOR.NR_CARTAO_SALARIO,
DIRETOR.DV_CARTAO_SALARIO,
DIRETOR.GRAU_INSTRUCAO,
DIRETOR.DEFICIENTE,
COALESCE((SELECT MAX(MUNICIPIOG.CD_MUNICIPIO_CONCLA )
		   FROM EBS_Cordilheira.DBO.MUNICIPIOG 
		  WHERE MUNICIPIOG.CD_MUNICIPIO = DIRETOR.CD_MUNICIPIO  
		    AND MUNICIPIOG.ESTADO = DIRETOR.ESTADO), (SELECT MAX(MUNICIPIOCGW.CD_MUNICIPIO_IBGE )
													    FROM EBS_Cordilheira.DBO.MUNICIPIOCGW 
													   WHERE MUNICIPIOCGW.CD_MUNICIPIO_IBGE = DIRETOR.CD_MUNICIPIO  
												 		 AND MUNICIPIOCGW.UF = DIRETOR.ESTADO)) AS CODIGO_IBGE_ENDERECO,
COALESCE((SELECT MAX(MUNICIPIOG.CD_MUNICIPIO_CONCLA )
		   FROM EBS_Cordilheira.DBO.MUNICIPIOG 
		  WHERE MUNICIPIOG.CD_MUNICIPIO = DIRETOR.CD_MUNICIPIO_NASCIMENTO  
			AND MUNICIPIOG.ESTADO = DIRETOR.ESTADO_NASCIMENTO), (SELECT MAX(MUNICIPIOCGW.CD_MUNICIPIO_IBGE )
																   FROM EBS_Cordilheira.DBO.MUNICIPIOCGW 
																  WHERE MUNICIPIOCGW.CD_MUNICIPIO_IBGE = DIRETOR.CD_MUNICIPIO_NASCIMENTO  
																	AND MUNICIPIOCGW.UF = DIRETOR.ESTADO_NASCIMENTO)) AS CODIGO_IBGE_NASCIMENTO
	
FROM EBS_CORDILHEIRA.DBO.DIRETOR
LEFT JOIN (
    SELECT
        CD_EMPRESA,
        CD_DIRETOR,
        MAX(DATEFROMPARTS(ANO, MES, 1)) AS MAX_DATE
    FROM DBO.RETIRADA
    GROUP BY CD_EMPRESA, CD_DIRETOR
) SUBQ ON DIRETOR.CD_EMPRESA = SUBQ.CD_EMPRESA AND DIRETOR.CD_DIRETOR = SUBQ.CD_DIRETOR
LEFT JOIN DBO.RETIRADA 
	ON DIRETOR.CD_EMPRESA = RETIRADA.CD_EMPRESA 
	AND DIRETOR.CD_DIRETOR = RETIRADA.CD_DIRETOR 
	AND DATEFROMPARTS(RETIRADA.ANO, RETIRADA.MES, 1) = SUBQ.MAX_DATE
ORDER BY DIRETOR.CD_EMPRESA, DIRETOR.CD_DIRETOR