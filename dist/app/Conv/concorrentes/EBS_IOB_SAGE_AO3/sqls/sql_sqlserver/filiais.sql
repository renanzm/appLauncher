DECLARE @retorno int
DECLARE @query VARCHAR(8000)
DECLARE @query_2 VARCHAR(8000)
SET @query = 'SELECT 
CRDESTABELECIMENTO.CD_EMPRESA,
CRDESTABELECIMENTO.CD_ESTABELECIMENTO,
RAZAO,
ENDERECO,
NUMERO,
COMPLEMENTO,
BAIRRO,
CIDADE,
CEP,
UF,       
DDD_TELEFONE,
TELEFONE,
DDD_FAX,
FAX,
CNPJ_CPF,
INSCRICAO_EST,
INSCRICAO_MUN,
CODIGO_CEI,
CNAE,
CRDEstabelecimentoVigencia.DT_INICIO_VIGENCIA,
CRDEstabelecimentoVigencia.PERC_FILANTROPIA,
CRDEstabelecimentoVigencia.CD_FPAS as CODIGO_FPAS,
CRDEstabelecimentoVigencia.ALIQ_FPAS,
CRDEstabelecimentoVigencia.ALIQ_FPAS_PROLABORE,
'''' AS ALIQ_SAT,
CRDEstabelecimentoVigencia.CD_TERCEIROS as CODIGO_TERCEIROS,
CRDEstabelecimentoVigencia.ALIQ_TERCEIROS,
(SELECT MAX(CRDEstabelecimentoparametro.ID_ESOCIAL) FROM EBS_Cordilheira.CRDEstabelecimentoparametro WHERE CRDEstabelecimentoparametro.cd_empresa = CRDEstabelecimento.cd_empresa AND CRDEstabelecimentoparametro.CD_ESTABELECIMENTO = CRDEstabelecimento.CD_ESTABELECIMENTO) AS ID_ESOCIAL,
CRDEstabelecimentoVigencia.ESOCIAL_CNO_OBRA as CNO,
CRDESTABELECIMENTOVIGENCIA.ESOCIAL_CAEPF as CAEPF,
COALESCE((SELECT MUNICIPIOG.CD_MUNICIPIO_CONCLA
FROM EBS_Cordilheira.DBO.MUNICIPIOG 
WHERE MUNICIPIOG.CD_MUNICIPIO = CRDESTABELECIMENTO.CD_MUNICIPIO  
AND MUNICIPIOG.ESTADO = CRDESTABELECIMENTO.UF
AND MUNICIPIOG.CD_MUNICIPIO_CONCLA <> 0), COALESCE((SELECT MUNICIPIOCGW.CD_MUNICIPIO_IBGE 
FROM EBS_Cordilheira.DBO.MUNICIPIOCGW 
WHERE MUNICIPIOCGW.CD_MUNICIPIO_IBGE = CRDESTABELECIMENTO.CD_MUNICIPIO  
AND MUNICIPIOCGW.UF = CRDESTABELECIMENTO.UF),(SELECT MUNICIPIOCGW.CD_MUNICIPIO_IBGE 
FROM EBS_Cordilheira.DBO.MUNICIPIOCGW 
WHERE MUNICIPIOCGW.DESCRICAO = CRDESTABELECIMENTO.CIDADE  
AND MUNICIPIOCGW.UF = CRDESTABELECIMENTO.UF))) AS CODIGO_IBGE,
(SELECT MAX(CRDEstabelecimentoParametro.tipo_logradouro) FROM EBS_CORDILHEIRA.DBO.CRDEstabelecimentoParametro WHERE CRDEstabelecimentoparametro.cd_empresa = CRDEstabelecimento.cd_empresa AND CRDEstabelecimentoparametro.CD_ESTABELECIMENTO = CRDEstabelecimento.CD_ESTABELECIMENTO) AS TIPO_LOGRADOURO,
CRDESTABELECIMENTOVIGENCIA.ALIQ_FAP
FROM EBS_Cordilheira.DBO.CRDESTABELECIMENTO
JOIN EBS_Cordilheira.crdestabelecimentovigencia
ON CRDESTABELECIMENTO.cd_empresa = crdestabelecimentovigencia.cd_empresa
AND CRDESTABELECIMENTO.cd_estabelecimento = crdestabelecimentovigencia.cd_estabelecimento
ORDER BY CD_EMPRESA, CD_ESTABELECIMENTO'
SET @query_2 = 'SELECT 
CRDESTABELECIMENTO.CD_EMPRESA,
CRDESTABELECIMENTO.CD_ESTABELECIMENTO,
RAZAO,
ENDERECO,
NUMERO,
COMPLEMENTO,
BAIRRO,
CIDADE,
CEP,
UF,       
DDD_TELEFONE,
TELEFONE,
DDD_FAX,
FAX,
CNPJ_CPF,
INSCRICAO_EST,
INSCRICAO_MUN,
CODIGO_CEI,
CNAE,
CRDEstabelecimentoVigencia.DT_INICIO_VIGENCIA,
CRDEstabelecimentoVigencia.PERC_FILANTROPIA,
CRDEstabelecimentoVigencia.CD_FPAS as CODIGO_FPAS,
CRDEstabelecimentoVigencia.ALIQ_FPAS,
CRDEstabelecimentoVigencia.ALIQ_FPAS_PROLABORE,
'''' AS ALIQ_SAT,
CRDEstabelecimentoVigencia.CD_TERCEIROS as CODIGO_TERCEIROS,
CRDEstabelecimentoVigencia.ALIQ_TERCEIROS,
(SELECT MAX(CRDEstabelecimentoparametro.ID_ESOCIAL) FROM EBS_Cordilheira.dbo.CRDEstabelecimentoparametro WHERE CRDEstabelecimentoparametro.cd_empresa = CRDEstabelecimento.cd_empresa AND CRDEstabelecimentoparametro.CD_ESTABELECIMENTO = CRDEstabelecimento.CD_ESTABELECIMENTO) AS ID_ESOCIAL,
CRDEstabelecimentoVigencia.ESOCIAL_CNO_OBRA as CNO,
CRDESTABELECIMENTOVIGENCIA.ESOCIAL_CAEPF as CAEPF,
COALESCE((SELECT MUNICIPIOG.CD_MUNICIPIO_CONCLA
FROM EBS_Cordilheira.DBO.MUNICIPIOG 
WHERE MUNICIPIOG.CD_MUNICIPIO = CRDESTABELECIMENTO.CD_MUNICIPIO  
AND MUNICIPIOG.ESTADO = CRDESTABELECIMENTO.UF
AND MUNICIPIOG.CD_MUNICIPIO_CONCLA <> 0), COALESCE((SELECT MUNICIPIOCGW.CD_MUNICIPIO_IBGE 
FROM EBS_Cordilheira.DBO.MUNICIPIOCGW 
WHERE MUNICIPIOCGW.CD_MUNICIPIO_IBGE = CRDESTABELECIMENTO.CD_MUNICIPIO  
AND MUNICIPIOCGW.UF = CRDESTABELECIMENTO.UF),(SELECT MUNICIPIOCGW.CD_MUNICIPIO_IBGE 
FROM EBS_Cordilheira.DBO.MUNICIPIOCGW 
WHERE MUNICIPIOCGW.DESCRICAO = CRDESTABELECIMENTO.CIDADE  
AND MUNICIPIOCGW.UF = CRDESTABELECIMENTO.UF))) AS CODIGO_IBGE,
(SELECT MAX(CRDEstabelecimentoParametro.tipo_logradouro) FROM EBS_CORDILHEIRA.DBO.CRDEstabelecimentoParametro WHERE CRDEstabelecimentoparametro.cd_empresa = CRDEstabelecimento.cd_empresa AND CRDEstabelecimentoparametro.CD_ESTABELECIMENTO = CRDEstabelecimento.CD_ESTABELECIMENTO) AS TIPO_LOGRADOURO,
CRDESTABELECIMENTOVIGENCIA.ALIQ_FAP
FROM EBS_Cordilheira.dbo.CRDESTABELECIMENTO
JOIN EBS_Cordilheira.dbo.crdestabelecimentovigencia
ON CRDESTABELECIMENTO.cd_empresa = crdestabelecimentovigencia.cd_empresa
AND CRDESTABELECIMENTO.cd_estabelecimento = crdestabelecimentovigencia.cd_estabelecimento
ORDER BY CD_EMPRESA, CD_ESTABELECIMENTO;'
SELECT @retorno = COUNT(COLUMN_NAME) FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'CRDESTABELECIMENTOVIGENCIA';
IF (@retorno > 0)
BEGIN
    exec (@query_2)
END
ELSE
BEGIN
    exec (@query)
END