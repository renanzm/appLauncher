--EMPRESAS
SELECT  ES.CD_EMPRESA AS CODI_EMP,
        CAST(ES.CD_EMPRESA as varchar(30)) AS CODIGO,
        ES.RECIBO_ESOCIAL,
        CAST(ES.CD_EMPRESA AS VARCHAR(06)) AS CODIGO_ESOCIAL,
        '1000' AS EVENTO,
        '' AS DATA_TIPO_RESCISAO
FROM EBS_Cordilheira.DBO.EVENTOTRANSMISSAOESOCIAL AS ES
WHERE ES.RECIBO_ESOCIAL <> '' 
  AND SUBSTRING(ES.RECIBO_ESOCIAL, 0, 5 ) = '1.1.' 
  AND ES.CD_TIPO_EVENTO IN ('S-1000') 
  AND CAST(CD_EMPRESA as varchar(30)) IS NOT NULL

UNION ALL

--CARGOS
SELECT  ES.CD_EMPRESA AS CODI_EMP,
        CAST(EV.CODIGO as varchar(30)) AS CODIGO,
        ES.RECIBO_ESOCIAL,
        ISNULL((SELECT MAX(FUNCAO.ID_ESOCIAL)
                  FROM EBS_Cordilheira.DBO.FUNCAO 
                 WHERE CAST(FUNCAO.ENTERPRISE_ID AS varchar(30)) = CAST(ES.CD_EMPRESA AS varchar(30)) 
                   AND CAST(FUNCAO.CD_FUNCAO AS varchar(30)) = CAST(EV.CODIGO AS varchar(30))
               ), EV.CODIGO) AS CODIGO_ESOCIAL,
        '1030' AS EVENTO,
        '' AS DATA_TIPO_RESCISAO
FROM EBS_Cordilheira.DBO.EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN EBS_Cordilheira.DBO.CRHCONTROLETRANSMISSAOESOCIALEVENTOS1030 AS EV
    ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
WHERE ES.RECIBO_ESOCIAL <> '' 
  AND SUBSTRING(ES.RECIBO_ESOCIAL, 0, 5 ) = '1.1.' 
  AND ES.CD_TIPO_EVENTO IN ('S-1030') 
  AND CAST(EV.CODIGO as varchar(30)) IS NOT NULL
	  
UNION ALL

--FUNCIONARIOS
SELECT  ES.CD_EMPRESA AS CODI_EMP,
        CAST(EV.CODIGO as varchar(30)) AS CODIGO,
        ES.RECIBO_ESOCIAL,
        CAST(FUN.MATRICULA_ESOCIAL as varchar(30)) AS CODIGO_ESOCIAL,
        '2200' AS EVENTO,
        '' AS DATA_TIPO_RESCISAO
FROM EBS_Cordilheira.DBO.EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN EBS_Cordilheira.DBO.CRHCONTROLETRANSMISSAOESOCIALEVENTOS2200 AS EV
    ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
LEFT JOIN EBS_Cordilheira.DBO.FUNCIONARIO AS FUN
    ON CAST(ES.CD_EMPRESA AS varchar(30)) = CAST(FUN.CD_EMPRESA AS varchar(30))
   AND CAST(EV.CODIGO as varchar(30)) = CAST(FUN.CD_FUNCIONARIO as varchar(30))
WHERE ES.RECIBO_ESOCIAL <> '' 
  AND SUBSTRING(ES.RECIBO_ESOCIAL, 0, 5 ) = '1.1.' 
  AND ES.CD_TIPO_EVENTO IN ('S-2200') 
  AND CAST(EV.CODIGO as varchar(30)) IS NOT NULL
	 
UNION ALL

--ALTERACOES CADASTRAIS
SELECT  ES.CD_EMPRESA AS CODI_EMP,
        (SELECT CASE
                    WHEN CHARINDEX('|',EV.CODIGO)>0 THEN CAST(LEFT(EV.CODIGO, CHARINDEX('|', EV.CODIGO) - 1) as varchar(30))
                    ELSE CAST(EV.CODIGO as varchar(30))
                END) AS CODIGO,
        ES.RECIBO_ESOCIAL,
        (SELECT CASE
                    WHEN CHARINDEX('|',EV.CODIGO)>0 THEN CAST(LEFT(EV.CODIGO, CHARINDEX('|', EV.CODIGO) - 1) as varchar(30))
                    ELSE CAST(EV.CODIGO as varchar(30))
                END) AS CODIGO_ESOCIAL,
        '2205' AS EVENTO,
        CONVERT(varchar,EV.DT_REFERENCIA,23) AS DATA_TIPO_RESCISAO
FROM EBS_Cordilheira.DBO.EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN EBS_Cordilheira.DBO.CRHCONTROLETRANSMISSAOESOCIALEVENTOS2205 AS EV
    ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
WHERE ES.RECIBO_ESOCIAL <> '' 
  AND SUBSTRING(ES.RECIBO_ESOCIAL, 0, 5 ) = '1.1.' 
  AND ES.CD_TIPO_EVENTO IN ('S-2205') 
  AND (SELECT CASE
                WHEN CHARINDEX('|',EV.CODIGO)>0 THEN CAST(LEFT(EV.CODIGO, CHARINDEX('|', EV.CODIGO) - 1)as varchar(30))
                ELSE CAST(EV.CODIGO as varchar(30))
              END) IS NOT NULL
	  
UNION ALL

--ALTERACOES CONTRATUAIS
SELECT  ES.CD_EMPRESA AS CODI_EMP,
        (SELECT CASE
                    WHEN CHARINDEX('|',EV.CODIGO)>0 THEN CAST(LEFT(EV.CODIGO, CHARINDEX('|', EV.CODIGO) - 1) as varchar(30))
                    ELSE CAST(EV.CODIGO as varchar(30))
                END) AS CODIGO,
        ES.RECIBO_ESOCIAL,
        (SELECT CASE
                    WHEN CHARINDEX('|',EV.CODIGO)>0 THEN CAST(LEFT(EV.CODIGO, CHARINDEX('|', EV.CODIGO) - 1) as varchar(30))
                    ELSE CAST(EV.CODIGO as varchar(30))
                END) AS CODIGO_ESOCIAL,
        '2206' AS EVENTO,
        CONVERT(varchar,EV.DT_REFERENCIA,23) AS DATA_TIPO_RESCISAO
FROM EBS_Cordilheira.DBO.EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN EBS_Cordilheira.DBO.CRHCONTROLETRANSMISSAOESOCIALEVENTOS2206 AS EV
    ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
WHERE ES.RECIBO_ESOCIAL <> '' 
  AND SUBSTRING(ES.RECIBO_ESOCIAL, 0, 5 ) = '1.1.' 
  AND ES.CD_TIPO_EVENTO IN ('S-2206') 
  AND (SELECT CASE
                WHEN CHARINDEX('|',EV.CODIGO)>0 THEN CAST(LEFT(EV.CODIGO, CHARINDEX('|', EV.CODIGO) - 1)as varchar(30))
                ELSE CAST(EV.CODIGO as varchar(30))
              END) IS NOT NULL
	  
UNION ALL

--CONTRIBUINTES
SELECT  ES.CD_EMPRESA AS CODI_EMP,
        CAST(EV.CODIGO as varchar(30)) AS CODIGO,
        ES.RECIBO_ESOCIAL,
        COALESCE(CAST(DIR.MATRICULA_ESOCIAL as varchar(30)), CAST(FUN.MATRICULA_ESOCIAL as varchar(30))) AS CODIGO_ESOCIAL,
        '2300' AS EVENTO,
        '' AS DATA_TIPO_RESCISAO
FROM EBS_Cordilheira.DBO.EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN EBS_Cordilheira.DBO.CRHCONTROLETRANSMISSAOESOCIALEVENTOS2300 AS EV
    ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
LEFT JOIN EBS_Cordilheira.DBO.DIRETOR AS DIR
    ON CAST(ES.CD_EMPRESA AS varchar(30)) = CAST(DIR.CD_EMPRESA AS varchar(30))
   AND CAST(EV.CODIGO as varchar(30)) = CAST(DIR.CD_DIRETOR as varchar(30))
LEFT JOIN EBS_Cordilheira.DBO.FUNCIONARIO AS FUN
    ON CAST(ES.CD_EMPRESA AS varchar(30)) = CAST(FUN.CD_EMPRESA AS varchar(30))
   AND CAST(EV.CODIGO as varchar(30)) = CAST(FUN.CD_FUNCIONARIO as varchar(30))
WHERE ES.RECIBO_ESOCIAL <> '' 
  AND SUBSTRING(ES.RECIBO_ESOCIAL, 0, 5) = '1.1.'
  AND ES.CD_TIPO_EVENTO IN ('S-2300')
  AND CAST(EV.CODIGO as varchar(30)) IS NOT NULL
	  
UNION ALL

--ALTERACOES CONTRATUAIS
SELECT  ES.CD_EMPRESA AS CODI_EMP,
        CAST(EV.CODIGO as varchar(30)) AS CODIGO,
        ES.RECIBO_ESOCIAL,
        CAST(EV.CODIGO as varchar(30)) AS CODIGO_ESOCIAL,
        '2306' AS EVENTO,
        CONVERT(varchar,EV.DT_REFERENCIA,23) AS DATA_TIPO_RESCISAO
FROM EBS_Cordilheira.DBO.EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN EBS_Cordilheira.DBO.CRHCONTROLETRANSMISSAOESOCIALEVENTOS2306 AS EV
    ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
WHERE ES.RECIBO_ESOCIAL <> '' 
  AND SUBSTRING(ES.RECIBO_ESOCIAL, 0, 5 ) = '1.1.' 
  AND ES.CD_TIPO_EVENTO IN ('S-2306') 
  AND CAST(EV.CODIGO as varchar(30)) IS NOT NULL

UNION ALL

--TOMADORES - S1005
SELECT  ES.CD_EMPRESA AS CODI_EMP,
        CAST(EV.CODIGO as varchar(30)) AS CODIGO,
        ES.RECIBO_ESOCIAL,
        ISNULL((SELECT MAX(TOMADOR.ID_ESOCIAL) 
                  FROM EBS_CORDILHEIRA.DBO.TOMADOR 
                 WHERE CAST(TOMADOR.cd_empresa AS varchar(30)) = CAST(ES.cd_empresa AS varchar(30)) 
                   AND CAST(TOMADOR.cd_tomador AS varchar(30)) = CAST(EV.CODIGO AS varchar(30))
               ), EV.CODIGO) AS CODIGO_ESOCIAL,
        '1005' AS EVENTO,
        CONVERT(varchar,EV.DT_REFERENCIA,23) AS DATA_TIPO_RESCISAO
FROM EBS_Cordilheira.DBO.EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN EBS_Cordilheira.DBO.CRHCONTROLETRANSMISSAOESOCIALEVENTOS1005 AS EV
    ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
WHERE ES.RECIBO_ESOCIAL <> '' 
  AND SUBSTRING(ES.RECIBO_ESOCIAL, 0, 5 ) = '1.1.' 
  AND ES.CD_TIPO_EVENTO IN ('S-1005') 
  AND CAST(EV.CODIGO as varchar(30)) IS NOT NULL
	  
UNION ALL

--TOMADORES - S1020
SELECT  ES.CD_EMPRESA AS CODI_EMP,
        CAST(EV.CODIGO as varchar(30)) AS CODIGO,
        ES.RECIBO_ESOCIAL,
        ISNULL((SELECT MAX(TOMADOR.ID_ESOCIAL) 
                  FROM EBS_CORDILHEIRA.DBO.TOMADOR 
                 WHERE CAST(TOMADOR.cd_empresa AS varchar(30)) = CAST(ES.cd_empresa AS varchar(30)) 
                   AND CAST(TOMADOR.cd_tomador AS varchar(30)) = CAST(EV.CODIGO AS varchar(30))
               ), EV.CODIGO) AS CODIGO_ESOCIAL,
        '1020' AS EVENTO,
        CONVERT(varchar,EV.DT_REFERENCIA,23) AS DATA_TIPO_RESCISAO
FROM EBS_Cordilheira.DBO.EVENTOTRANSMISSAOESOCIAL AS ES
INNER JOIN EBS_Cordilheira.DBO.CRHCONTROLETRANSMISSAOESOCIALEVENTOS1020 AS EV
    ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
WHERE ES.RECIBO_ESOCIAL <> '' 
  AND SUBSTRING(ES.RECIBO_ESOCIAL, 0, 5 ) = '1.1.' 
  AND ES.CD_TIPO_EVENTO IN ('S-1020') 
  AND CAST(EV.CODIGO as varchar(30)) IS NOT NULL

UNION ALL

--S2230
SELECT ES.CD_EMPRESA AS CODI_EMP,
       CASE 
           WHEN CHARINDEX('|', EV.CODIGO) > 0 THEN LEFT(EV.CODIGO, CHARINDEX('|', EV.CODIGO) - 1)
           ELSE EV.CODIGO
       END AS CODIGO,
       ES.RECIBO_ESOCIAL,
       CASE 
           WHEN CHARINDEX('|', EV.CODIGO) > 0 THEN LEFT(EV.CODIGO, CHARINDEX('|', EV.CODIGO) - 1)
           ELSE EV.CODIGO
       END AS CODIGO_ESOCIAL,
       '2230' AS EVENTO,
       CASE 
           WHEN CHARINDEX('|', EV.CODIGO) > 0 THEN RIGHT(EV.CODIGO, LEN(EV.CODIGO) - CHARINDEX('|', EV.CODIGO))
           ELSE NULL
       END AS DATA_TIPO_RESCISAO
FROM EBS_CORDILHEIRA.DBO.EVENTOTRANSMISSAOESOCIAL AS ES 
INNER JOIN EBS_CORDILHEIRA.DBO.CRHCONTROLETRANSMISSAOESOCIALEVENTOS2230 AS EV
    ON EV.NR_PROTOCOLO_TRANSMISSOR = ES.ID_PROTOCOLO
WHERE CD_TIPO_EVENTO IN ('S-2230')
  AND ES.RECIBO_ESOCIAL <> ''  
  AND SUBSTRING(ES.RECIBO_ESOCIAL, 0, 5 ) = '1.1.'
  AND CAST(EV.CODIGO as varchar(30)) IS NOT NULL

ORDER BY 1,5,2 DESC;
