WITH AFAST_FIM AS (
	SELECT SUB.DATA_MOV,
	       SUB.ID_ORIGEM
	FROM MOVIMENTACAO AS SUB
)
SELECT MOVIMENTACAO.COD_EMP,
       MOVIMENTACAO.COD_FUN,
       MOVIMENTACAO.TIPO,
       MOVIMENTACAO.DATA_MOV,
       AFAST_FIM.DATA_MOV AS DATA_FIM,
       MOVIMENTACAO_TABELA.CODIGO_ESOCIAL
FROM MOVIMENTACAO
LEFT JOIN AFAST_FIM
	ON AFAST_FIM.ID_ORIGEM = MOVIMENTACAO.ID
LEFT JOIN MOVIMENTACAO_TABELA
	ON MOVIMENTACAO_TABELA.ID = MOVIMENTACAO.ID_MOVIMENTACAO_TABELA
	AND MOVIMENTACAO_TABELA.DATA_BLOQUEADO IS NULL
WHERE MOVIMENTACAO.ID_ORIGEM = 0
AND MOVIMENTACAO_TABELA.CODIGO_ESOCIAL <> 15
ORDER BY 1, 2, 3, 4