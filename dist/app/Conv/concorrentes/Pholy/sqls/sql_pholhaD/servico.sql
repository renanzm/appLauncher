WITH ULTIMA_VIGENCIA AS (
	SELECT sub.CODEMP,
	       MAX(sub.ANOMES) AS ANOMES
	FROM PHTEMP2 AS sub
	GROUP BY sub.CODEMP
)
SELECT DISTINCT
       PHCLOT.CODEMP,
       PHTEMP2.TABTOM,
       PHCLOT.CODTOM,
       PHTTOM2.ANOMES,
       PHTTOM.NOMINT,
       PHTTOM.ENDERE,
       PHTTOM.NUMERO,
       PHTTOM.COMPLE,
       PHTTOM.BAIRRO,
       PHTTOM.CIDADE,
       PHTTOM.ESTADO,
       PHTTOM.NUMCEP,
       PHTTOM.CMPCEP,
       PHTTOM.CODMUN,
       PHTTOM.NUMDDD,
       PHTTOM.TELEFO,
       PHTTOM.NUMINS,
       PHTTOM.NUMCEI,
       PHTTOM2.SFPREC,
       PHTTOM2.GPSPGT,
       PHTTOM2.GPSFPA,
       PHTTOM2.GPSTER,
       PHTTOM2.GPSACI,
       PHTTOM2.FILANT,
	   PHTEMP.ATICOD
FROM PHCLOT
INNER JOIN ULTIMA_VIGENCIA
	ON ULTIMA_VIGENCIA.CODEMP = PHCLOT.CODEMP
INNER JOIN PHTEMP2
	ON PHTEMP2.CODEMP = ULTIMA_VIGENCIA.CODEMP
	AND PHTEMP2.ANOMES = ULTIMA_VIGENCIA.ANOMES
INNER JOIN PHTTOM2
	ON PHTEMP2.TABTOM = PHTTOM2.CODTAB
	AND PHCLOT.CODTOM = PHTTOM2.CODNIV
LEFT JOIN PHTTOM
    ON PHTTOM.CODTAB = PHTTOM2.CODTAB
   AND PHTTOM.CODNIV = PHTTOM2.CODNIV
INNER JOIN PHTEMP
	ON PHTEMP.CODEMP = PHTEMP2.CODEMP
 ORDER BY 1, 2, 3, 4