WITH ULTIMA_VIGENCIA AS (
	SELECT sub.CODEMP,
	       MAX(sub.ANOMES) AS ANOMES
	FROM PHTEMP2 AS sub
	GROUP BY sub.CODEMP
)
SELECT PHCLOT.CODEMP,
       PHCLOT.CODCAD,
       PHCLOT.ANOMES,
       PHCLOT.CODDEP,
       PHCLOT.CODCCU,
       PHTEMP2.TABTOM,
       PHCLOT.CODTOM
FROM PHCLOT
INNER JOIN ULTIMA_VIGENCIA
	ON ULTIMA_VIGENCIA.CODEMP = PHCLOT.CODEMP
INNER JOIN PHTEMP2
	ON PHTEMP2.CODEMP = ULTIMA_VIGENCIA.CODEMP
	AND PHTEMP2.ANOMES = ULTIMA_VIGENCIA.ANOMES
ORDER BY 1, 2, 3