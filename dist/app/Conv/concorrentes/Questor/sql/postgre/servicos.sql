WITH UltimaGPS AS (
    SELECT g1.CODIGOEMPRESA,
           MAX(g1.CODIGOTABGPS) AS CODIGOTABGPS,
           MAX(g1.DATAINICIAL) AS DATAINICIAL
      FROM GPS g1
     GROUP BY g1.CODIGOEMPRESA
)
SELECT e.CODIGOEMPRESA,
       e.CODIGOESTAB,
       g.DATAINICIAL,
       g.CODIGOIMPOSTO,
       g.CODIGOFPAS,
       g.CODIGOACIDTRAB,
       g.TERCEIROS,
       g.PERCPARTEEMP,
       g.PERCPARTETERC,
       g.PERCDIRAUTON,
       g.PERCISENCAOFILANT,
       REPLACE(e.NOMEESTABCOMPLETO, ',', ' ') AS NOMEEMPRESA,
       REPLACE(e.NOMEFANTASIA, ',', ' ') AS NOMEFANTASIA,
       REPLACE(e.ENDERECOESTAB, ',', ' ') AS ENDERECOESTAB,
       e.NUMENDERESTAB,
       e.COMPLENDERESTAB,
       e.BAIRROENDERESTAB,
       e.DDDFONE,
       e.NUMEROFONE,
       e.CODIGOATIVFEDERAL,
       e.SIGLAESTADO,
       e.CODIGOMUNIC,
       e.CEPENDERESTAB,
       e.INSCRFEDERAL,
       m.NOMEMUNIC,
       m.CODIGORAIS,
       e.INSCRCAEPF
  FROM ESTAB e
  LEFT JOIN UltimaGPS ug
    ON ug.CODIGOEMPRESA = e.CODIGOEMPRESA
  LEFT JOIN GPS g
    ON g.CODIGOEMPRESA = ug.CODIGOEMPRESA
   AND g.CODIGOTABGPS = ug.CODIGOTABGPS
   AND g.DATAINICIAL = ug.DATAINICIAL
  LEFT JOIN MUNICIPIO m
    ON m.CODIGOMUNIC = e.CODIGOMUNIC
   AND m.SIGLAESTADO = e.SIGLAESTADO
 ORDER BY e.CODIGOEMPRESA,
          e.CODIGOESTAB,
          g.DATAINICIAL
