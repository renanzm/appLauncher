WITH ULTIMO_SEGURO AS (
	SELECT CODIGOEMPRESA,
	       CODIGOFUNCCONTR,
	       MAX(DATAINICIAL) AS DATAINICIAL
	FROM FUNCSEGURO
	GROUP BY 1, 2
),
ULTIMAS_CTPS AS (
	SELECT FTD.CODIGOEMPRESA,
           FTD.CODIGOFUNCCONTR,
           MAX(FTD.DATAINICIAL) DATAINICIAL
   FROM FUNCCTPS FTD
   GROUP BY FTD.CODIGOEMPRESA, FTD.CODIGOFUNCCONTR
)
SELECT func.CODIGOEMPRESA,
       func.CODIGOFUNCCONTR,
       FP.NOMEFUNC,
       FP.CODIGOTIPOLOGRAD,
       FP.ENDERFUNC,
       FP.NUMEROENDER,
       FP.COMPLENDER,
       FP.BAIRROFUNC,
       FP.SIGLAESTADO,
       FP.CODIGOMUNIC,
       FP.CEPFUNC,
       FP.ENDERELETR,
       FP.DDDFONE,
       FP.NUMEROFONE,
       FP.DDDCELULAR,
       FP.NUMEROCELULAR,
       FP.DATANASC,
       FP.SIGLAESTADONASC,
       FP.SEXO,
       FP.RACACOR,
       FP.DEFFISICA,
       FP.ESTADOCIVIL,
       FP.GRAUINSTR,
       FP.NACIONALIDADE,
       FP.DATACHEGADA,
       FTD.NUMEROCTPS,
       FTD.SERIECTPS,
       FTD.SIGLAESTADOCTPS,
       FTD.EXPEDCTPS,
       FP.PISFUNC,
       FP.DATACADPIS,
       FP.CPFFUNC,
       FP.NUMERORG,
       OERG.SIGLAORGAOEMISSOR AS ORGEMISRG,
       FP.SIGLAESTADORG,
       FP.EMISSRG,
       FP.TITELEIT,
       FP.ZONATITELEIT,
       FP.SECAOTITELEIT,
       FP.CNHFUNC,
       OECNH.SIGLAORGAOEMISSOR AS ORGEMISCNH,
       FP.UFCNH,
       FP.CATEGCNH,
       FP.VALIDCNH,
       FP.EXPEDICAOCNH,
       FP.CARTRESERV,
       FP.CATEGCARTRESERV,
       FP.PASSAPNUMERO,
       FP.PASSAPSIGLAESTADO,
       FP.PASSAPEMISSAO,
       FP.PASSAPVALIDADE,
       OEPASPORT.SIGLAORGAOEMISSOR AS ORGEMISEPASPORT,
       FP.RICNUMERO,
       OERIC.SIGLAORGAOEMISSOR AS ORGEMISRIC,
       MUN_RIC.CODIGORAIS AS IBGE_RIC,
       FP.RICDATAEXPED,
       FP.CARTRNE,
       OERNE.SIGLAORGAOEMISSOR AS ORGEMISRNE,
       FP.EXPEDICAORNE,
       FP.VALIDRNE,
       FP.PAISORIGEM,
       FP.FILHOSBR,
       FP.DEFFISICA,
       FP.DEFVISUAL,
       FP.DEFAUDITIVA,
       FP.DEFMENTAL,
       FP.DEFINTELECTUAL,
       FP.DEFREABILITADO,
       FP.DEFOBS,
       FP.DEFCOTA,
       func.CODIGOTIPOCONTR,
       func.DATAADM,
       func.OPTANTEFGTS,
       func.DATAOPCAOFGTS,
       func.TIPOVINCULO,
       func.SIGLAESTADOMINREG,
       func.CODIGOCATEG,
       func.CATEGORIA,
       (SELECT FIRST 1 S3.CODIGOSIND
          FROM FUNCSINDICATO S3
         WHERE S3.CODIGOEMPRESA = func.CODIGOEMPRESA
           AND S3.CODIGOFUNCCONTR = func.CODIGOFUNCCONTR
           ORDER BY  S3.DATAINICIAL) AS CODIGOSIND,
       func.MODOPGTO,
       func.RECEBEADTO,
       func.PERCADTO,
       func.CODIGOBANCO,
       func.NUMEROAGENCIA,
       func.NUMEROCONTA,
       func.DIGITOCONTA,
       func.NUMEROINSCRINSS,
       func.DATADEM,
       func.DATADEM,
       func.INSTITUICAOENSINO,
       func.AGENTEINTEGRACAO,
       func.CODIGOSUPERVISORESTAGIO,
       func.AREAATUACAO,
       func.NATUREZAESTAGIO,
       func.NIVELESTAGIO,
       FUNCSEGURO.NUMEROAPOLICE,
       func.EMPCONTRATAPRENDIZ,
       (SELECT FIRST 1 S3.VALORSAL
          FROM FUNCSALARIO S3
         WHERE S3.CODIGOEMPRESA = func.CODIGOEMPRESA
           AND S3.CODIGOFUNCCONTR = func.CODIGOFUNCCONTR
           ORDER BY  S3.DATAINICIAL ASC) AS SALARIO,
       (SELECT FIRST 1 S3.TIPOSALARIO
        FROM FUNCSALARIO S3
        WHERE S3.CODIGOEMPRESA = func.CODIGOEMPRESA AND
              S3.CODIGOFUNCCONTR = func.CODIGOFUNCCONTR
              ORDER BY S3.DATAINICIAL ASC) AS TIPOSALARIO,
       (SELECT FIRST 1 C.CODIGOCARGO
          FROM FUNCCARGO C
         WHERE C.CODIGOEMPRESA = func.CODIGOEMPRESA
           AND C.CODIGOFUNCCONTR = func.CODIGOFUNCCONTR
		   ORDER BY C.DATAINICIAL ASC) AS CODIGOCARGO,
       (SELECT FIRST 1 CAST(E.CARGAHORMENSAL AS NUMERIC(10, 2)) / 60.0
          FROM FUNCESCALA FE,
               ESCALA E
         WHERE FE.CODIGOEMPRESA = func.CODIGOEMPRESA
           AND E.CODIGOESCALA = FE.CODIGOESCALA
           AND FE.CODIGOFUNCCONTR = func.CODIGOFUNCCONTR
           ORDER BY FE.DATAINICIAL DESC) AS CARGAHORAMENSAL,
       (SELECT FIRST 1 CAST(E.CARGAHORSEMANAL AS NUMERIC(10, 2)) / 60.0
          FROM FUNCESCALA FE,
               ESCALA E
         WHERE FE.CODIGOEMPRESA = func.CODIGOEMPRESA
           AND E.CODIGOESCALA = FE.CODIGOESCALA
           AND FE.CODIGOFUNCCONTR = func.CODIGOFUNCCONTR
           ORDER BY FE.DATAINICIAL DESC) AS CARGAHORASEMANAL,
       (SELECT FIRST 1 CAST(E.CARGAHORDIARIA AS NUMERIC(10, 2)) / 60.0
          FROM FUNCESCALA FE,
               ESCALA E
         WHERE FE.CODIGOEMPRESA = func.CODIGOEMPRESA
           AND E.CODIGOESCALA = FE.CODIGOESCALA
           AND FE.CODIGOFUNCCONTR = func.CODIGOFUNCCONTR
           ORDER BY FE.DATAINICIAL DESC) AS CARGAHORADIARIA,
       (SELECT FIRST 1 FL.CODIGOESTAB
          FROM FUNCLOCAL FL
         WHERE FL.CODIGOEMPRESA = func.CODIGOEMPRESA
           AND FL.CODIGOFUNCCONTR = func.CODIGOFUNCCONTR
           ORDER BY FL.DATATRANSF DESC) AS "LOCAL",
       (SELECT FIRST 1 DEP.NOMEDEPEND
          FROM DEPENDENTE DEP
         WHERE DEP.CODIGOEMPRESA = func.CODIGOEMPRESA
           AND DEP.CODIGOFUNCCONTR = func.CODIGOFUNCCONTR
           AND DEP.PARENTESCO = '03'
           AND DEP.SEXO = '2') AS MAE,
       (SELECT FIRST 1 DEP.NOMEDEPEND
          FROM DEPENDENTE DEP
         WHERE DEP.CODIGOEMPRESA = func.CODIGOEMPRESA
           AND DEP.CODIGOFUNCCONTR = func.CODIGOFUNCCONTR
           AND DEP.PARENTESCO = '03'
           AND DEP.SEXO = '1') AS PAI,
       (SELECT FIRST 1 MUN.NOMEMUNIC
          FROM MUNICIPIO MUN
         WHERE MUN.CODIGOMUNIC = FP.CODIGOMUNIC
           AND MUN.SIGLAESTADO = FP.SIGLAESTADO) AS CIDADE,
       (SELECT FIRST 1 MUN.NOMEMUNIC
          FROM MUNICIPIO MUN
         WHERE MUN.CODIGOMUNIC = FP.CODIGOMUNICNASC
           AND MUN.SIGLAESTADO = FP.SIGLAESTADONASC) AS CIDADENASC,
       (SELECT FIRST 1 PERIODOAQUIS.DATAFINAL
          FROM PERIODOAQUIS
         WHERE PERIODOAQUIS.CODIGOEMPRESA = func.CODIGOEMPRESA
           AND PERIODOAQUIS.CODIGOFUNCCONTR = func.CODIGOFUNCCONTR
           AND PERIODOAQUIS.SITPERIODO <> 1
		   ORDER BY PERIODOAQUIS.DATAFINAL DESC) AS VENC_FERIAS,
       func.MATRICULAESOCIAL,
       func.DIACONTREXP,
       func.DIAPRORROGCONTREXP,
       func.CATEGESOCIAL,
       transf.DATATRANSF,
       transf.TIPOAFASTSEFIP,
       emp.NOMEEMPRESA,
       est.INSCRFEDERAL,
	   FUNCADICIONAL.AGENTENOCIVO
FROM FUNCCONTRATO func
LEFT JOIN FUNCADICIONAL
	ON FUNCADICIONAL.CODIGOEMPRESA = func.CODIGOEMPRESA
 	AND FUNCADICIONAL.CODIGOFUNCCONTR = func.CODIGOFUNCCONTR
JOIN FUNCPESSOA FP
	ON FP.CODIGOFUNCPESSOA = func.CODIGOFUNCPESSOA
LEFT JOIN TRANSFFUNCSAIDA transf
	ON func.CODIGOEMPRESA = transf.CODIGOEMPRESA
   	AND func.CODIGOFUNCCONTR = transf.CODIGOFUNCCONTR
LEFT JOIN EMPRESA emp
	ON transf.CODIGOEMPRESA = emp.CODIGOEMPRESA
LEFT JOIN ESTAB est
	ON est.CODIGOEMPRESA = transf.CODIGOEMPRESA
   	AND est.CODIGOESTAB = transf.CODIGOESTAB
LEFT JOIN ORGAOEMISSOR OERG
	ON FP.CODIGOORGAOEMISSORRG = OERG.CODIGOORGAOEMISSOR
LEFT JOIN ORGAOEMISSOR OECNH
	ON FP.CODIGOORGAOEMISSORCNH = OECNH.CODIGOORGAOEMISSOR
LEFT JOIN ORGAOEMISSOR OEPASPORT
	ON FP.CODIGOORGAOEMISSORPASPORT = OEPASPORT.CODIGOORGAOEMISSOR
LEFT JOIN ORGAOEMISSOR OERIC
	ON FP.CODIGOORGAOEMISSORRIC = OERIC.CODIGOORGAOEMISSOR
LEFT JOIN ORGAOEMISSOR OERNE
	ON FP.CODIGOORGAOEMISSORRNE = OERNE.CODIGOORGAOEMISSOR
LEFT JOIN ULTIMAS_CTPS FCTD
	ON FCTD.CODIGOEMPRESA = func.CODIGOEMPRESA
	AND FCTD.CODIGOFUNCCONTR = func.CODIGOFUNCCONTR
LEFT JOIN FUNCCTPS FTD
	ON FTD.CODIGOEMPRESA = func.CODIGOEMPRESA
 	AND FTD.CODIGOFUNCCONTR = func.CODIGOFUNCCONTR
 	AND FTD.DATAINICIAL = FCTD.DATAINICIAL
LEFT JOIN ULTIMO_SEGURO
	ON ULTIMO_SEGURO.CODIGOEMPRESA = func.CODIGOEMPRESA
	AND ULTIMO_SEGURO.CODIGOFUNCCONTR = func.CODIGOFUNCCONTR
LEFT JOIN FUNCSEGURO
	ON FUNCSEGURO.CODIGOEMPRESA = ULTIMO_SEGURO.CODIGOEMPRESA
 	AND FUNCSEGURO.CODIGOFUNCCONTR = ULTIMO_SEGURO.CODIGOFUNCCONTR
 	AND FUNCSEGURO.DATAINICIAL = ULTIMO_SEGURO.DATAINICIAL
LEFT JOIN MUNICIPIO MUN_RIC
	ON MUN_RIC.CODIGOMUNIC = FP.RICMUNIC
	AND MUN_RIC.SIGLAESTADO = FP.RICSIGLAESTADO
ORDER BY func.CODIGOEMPRESA, func.CODIGOFUNCCONTR