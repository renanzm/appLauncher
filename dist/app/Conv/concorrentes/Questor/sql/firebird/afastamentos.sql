SELECT a.CODIGOEMPRESA,
       a.CODIGOFUNCCONTR,
       a.CODIGOSIT,
       a.DATAAFAST,
       a.DATATERMINO,
       (a.DATATERMINO - a.DATAAFAST) AS DIAS
  FROM AFASTAMENTO a
 WHERE a.CODIGOSIT NOT IN (1, 2, 7, 12, 16, 20)
   AND NOT EXISTS (SELECT 1 
                     FROM RECIBOFERIAS r 
                    WHERE r.CODIGOEMPRESA = a.CODIGOEMPRESA
                      AND r.CODIGOFUNCCONTR = a.CODIGOFUNCCONTR
                      AND a.DATAAFAST BETWEEN r.DATAINICIALFERIAS AND (r.DATAFINALFERIAS-r.DIASABONO))
   AND NOT EXISTS (SELECT 1
                     FROM RECIBOFERIAS r 
                    WHERE r.CODIGOEMPRESA = a.CODIGOEMPRESA
                      AND r.CODIGOFUNCCONTR = a.CODIGOFUNCCONTR
                      AND a.DATAAFAST < r.DATAINICIALFERIAS
                      AND a.DATATERMINO > (r.DATAFINALFERIAS-r.DIASABONO))
   AND NOT EXISTS (SELECT 1
                     FROM RECIBOFERIAS r 
                    WHERE r.CODIGOEMPRESA = a.CODIGOEMPRESA
                      AND r.CODIGOFUNCCONTR = a.CODIGOFUNCCONTR 
                      AND a.DATATERMINO BETWEEN r.DATAINICIALFERIAS AND (r.DATAFINALFERIAS-r.DIASABONO)
                      AND a.DATATERMINO-a.DATAAFAST < 180)
 ORDER BY CODIGOEMPRESA,
          CODIGOFUNCCONTR,
          DATAAFAST