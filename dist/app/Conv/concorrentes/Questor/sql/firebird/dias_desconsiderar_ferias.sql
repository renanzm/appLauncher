WITH ULTIMO_SINDICATO AS (
    SELECT 
        FS.CODIGOEMPRESA,
        FS.CODIGOFUNCCONTR,
        RF.DATAINICIAL AS DATAFERIAS,
        MAX(FS.DATAINICIAL) AS DATAINICIAL_SIND
    FROM RECIBOFERIAS RF
    JOIN FUNCSINDICATO FS
      ON FS.CODIGOEMPRESA   = RF.CODIGOEMPRESA
     AND FS.CODIGOFUNCCONTR = RF.CODIGOFUNCCONTR
     AND FS.DATAINICIAL <= RF.DATAINICIAL
    GROUP BY FS.CODIGOEMPRESA, FS.CODIGOFUNCCONTR, RF.DATAINICIAL
)
SELECT DISTINCT
       FS.CODIGOSIND,
       EXTRACT(DAY FROM RFD.DATA)   AS DIA,
       EXTRACT(MONTH FROM RFD.DATA) AS MES
FROM RECIBOFERIAS RF
INNER JOIN RECIBOFERIASDIASDESCON RFD
        ON RFD.CODIGOEMPRESA   = RF.CODIGOEMPRESA
       AND RFD.CODIGOFUNCCONTR = RF.CODIGOFUNCCONTR
       AND RFD.DATAINICIAL     = RF.DATAINICIAL
       AND RFD.DATAINICIALFERIAS = RF.DATAINICIALFERIAS
INNER JOIN FUNCCONTRATO FC
        ON FC.CODIGOEMPRESA   = RF.CODIGOEMPRESA
       AND FC.CODIGOFUNCCONTR = RF.CODIGOFUNCCONTR
INNER JOIN ULTIMO_SINDICATO US
        ON US.CODIGOEMPRESA   = RF.CODIGOEMPRESA
       AND US.CODIGOFUNCCONTR = RF.CODIGOFUNCCONTR
       AND US.DATAFERIAS      = RF.DATAINICIAL
INNER JOIN FUNCSINDICATO FS
        ON FS.CODIGOEMPRESA   = US.CODIGOEMPRESA
       AND FS.CODIGOFUNCCONTR = US.CODIGOFUNCCONTR
       AND FS.DATAINICIAL     = US.DATAINICIAL_SIND
