WITH PARAMETRO_CONTABIL AS (
	SELECT CODIGOEMPRESA,
	       MAX(DATAINICIALEXERC) AS DATAINICIALEXERC
	FROM CFGEMPRESACTB
	GROUP BY 1
)
SELECT emp.CODIGOEMPRESA,
       e.CODIGOESTAB,
       REPLACE(emp.NOMEEMPRESA, ',', ' ') AS NOMEEMPRESA,
       REPLACE(e.NOMEFANTASIA, ',', ' ') AS NOMEFANTASIA,
       e.CODIGOTIPOLOGRAD,
       REPLACE(e.enderecoestab, ',', ' ') AS ENDERECOESTAB,
       e.NUMENDERESTAB,
       REPLACE(e.COMPLENDERESTAB, ',', ' ') AS COMPLENDERESTAB,
       REPLACE(e.BAIRROENDERESTAB, ',', ' ') AS BAIRROENDERESTAB,
       e.SIGLAESTADO,
       e.CODIGOMUNIC,
       e.CEPENDERESTAB,
       e.DDDFONE,
       e.NUMEROFONE,
       e.DDDFAX,
       e.NUMEROFAX,
       e.EMAIL,
       e.INSCRMUNIC,
       e.INSCRESTAD,
       e.CODIGOATIVFEDERAL,
       REPLACE(e.DESCRATIVFEDESTAB, ',', ' ') AS DESCRATIVFEDESTAB,
       e.CODIGONATURJURID,
       e.INSCRFEDERAL,
       e.NUMEROREGIST,
       e.DATAREGIST,
       e.DATAINICIOATIV,
       mun.NOMEMUNIC,
       mun.CODIGOFEDERAL,
       mun.CODIGORAIS,
       e.CAPITALSOCIAL,
       e.VALORNOMINALCOTAS,
       e.INSCRCAEPF,
       e.CPFRESPCNO,
       e.CAIXAPOSTAL,
       contabil.CODIGOCONT,
       e.SUFRAMA,
       e.DATAENCERATIV,
	   EMPRESAHISTORICOSOC.CODIGOSOCIO
FROM EMPRESA emp
LEFT JOIN ESTAB e
	ON e.CODIGOEMPRESA = emp.CODIGOEMPRESA
LEFT JOIN municipio mun
	ON mun.CODIGOMUNIC = e.CODIGOMUNIC
	AND mun.SIGLAESTADO = e.SIGLAESTADO
LEFT JOIN PARAMETRO_CONTABIL
	ON PARAMETRO_CONTABIL.CODIGOEMPRESA = emp.CODIGOEMPRESA
LEFT JOIN (
    SELECT h.CODIGOEMPRESA, h.CODIGOSOCIO
    FROM EMPRESAHISTORICOSOC h
    WHERE h.DATAHISTORICO = (
        SELECT MAX(DATAHISTORICO)
        FROM EMPRESAHISTORICOSOC h2
        WHERE h2.CODIGOEMPRESA = h.CODIGOEMPRESA
    )
) EMPRESAHISTORICOSOC
    ON EMPRESAHISTORICOSOC.CODIGOEMPRESA = emp.CODIGOEMPRESA
LEFT JOIN CFGEMPRESACTB AS contabil
	ON PARAMETRO_CONTABIL.CODIGOEMPRESA = contabil.CODIGOEMPRESA
	AND PARAMETRO_CONTABIL.DATAINICIALEXERC = contabil.DATAINICIALEXERC
WHERE e.CODIGOESTAB = 1
ORDER BY emp.CODIGOEMPRESA, e.CODIGOESTAB