WITH TB_VINCULO AS (
  SELECT f.ID_FUNC_SADE,
         cat.CODIGO AS VINCULO,
         esoc.CODIGO AS CATEGORIA_ESOCIAL
    FROM FP_FUNCIONARIO_SADE_SALARIO f
    JOIN (SELECT ID_FUNC_SADE,
                 MAX("DATA") AS MAX_DATA
            FROM FP_FUNCIONARIO_SADE_SALARIO
           GROUP BY ID_FUNC_SADE) ult
      ON f.ID_FUNC_SADE = ult.ID_FUNC_SADE
     AND f."DATA" = ult.MAX_DATA
    LEFT JOIN GE_HELP cat
      ON cat.ID = f.CATEGORIASEFIP
    LEFT JOIN GE_HELP esoc
      ON esoc.ID = f.ID_CATEGORIA_ESOCIAL
)
SELECT FP_FUNCIONARIO_SADE.ID_EMPRESA,
       FP_FUNCIONARIO_SADE.CODIGO,
       FP_FUNCIONARIO_SADE.TIPO,
       FP_FUNCIONARIO_SADE.MATRICULA,
       FP_FUNCIONARIO_SADE.LIVRO_FOLHA,
       FP_FUNCIONARIO_SADE.NUM_FICHA,
       GE_PESSOAS.NOME,
       FP_FUNCIONARIO_SADE.DATA_ADMISSAO,
       GE_PESSOAS.DATA_NASCIMENTO,
       GE_PESSOAS.SEXO,
       (SELECT GE_HELP.CODIGO FROM GE_HELP WHERE GE_HELP.ID = GE_PESSOAS.ID_ESTADO_CIVIL) AS ESTADO_CIVIL,
       (SELECT GE_HELP.CODIGO FROM GE_HELP WHERE GE_HELP.ID = GE_PESSOAS.COR_RACA) AS RACA,
       (SELECT GE_HELP.CODIGO FROM GE_HELP WHERE GE_HELP.ID = GE_PESSOAS.ID_GRAU_INSTRUCAO) AS GRAU_INSTRUCAO,
       (SELECT GE_HELP.CODIGO FROM GE_HELP WHERE GE_HELP.ID = GE_PESSOAS.DEFICIENTE_FISICO) AS DEFICIENTE_FISICO,
       GE_PESSOAS.NOME_MAE,
       GE_PESSOAS.NOME_PAI,
       GE_PESSOAS.CONJUGE,
       GE_PESSOAS.EMAIL,
       GE_PESSOAS.DDD,
       GE_PESSOAS.TELEFONE,
       GE_PESSOAS.DDD_CELULAR,
       GE_PESSOAS.CELULAR,
       GE_PESSOAS.ENDERECO,
       GE_PESSOAS.BAIRRO,
       GE_PESSOAS.NUMERO,
       GE_PESSOAS.COMPLEMENTO,
       GE_PESSOAS.CEP,
       ENDERECO.NOME AS CIDADE,
       ENDERECO.UF AS ESTADO,
       ENDERECO.CODIGO AS CODIGO_IBGE,
       NASCIMENTO.NOME AS CIDADE_NASCIMENTO,
       NASCIMENTO.UF AS ESTADO_NASCIMENTO,
       NASCIMENTO.CODIGO AS CODIGO_IBGE_NASCIMENTO,
       (SELECT GE_HELP.CODIGO FROM GE_HELP WHERE GE_HELP.ID = GE_PESSOAS.ID_NACIONALIDADE) AS NACIONALIDADE,
       GE_PESSOAS.NATURALIZADO,
       GE_PESSOAS.DATA_NATURALIZACAO,
       GE_PESSOAS.ANO_CHEGADA_BRASIL,
       GE_PESSOAS.DATA_CHEGADA_BRASIL,
       GE_PESSOAS.CASADO_BRASILEIRO,
       GE_PESSOAS.FILHOS_BRASILEIROS,
       FP_FUNCIONARIO_SADE.TIPO_SADE,
       FP_FUNCIONARIO_SADE.EST_CNPJ_INST_ENSINO,
       FP_FUNCIONARIO_SADE.EST_RAZAO_SOCIAL_ENSINO,
       FP_FUNCIONARIO_SADE.EST_CNPJ_AGENTE,
       FP_FUNCIONARIO_SADE.EST_RAZAO_SOCIAL_AGENTE,
       FP_FUNCIONARIO_SADE.EST_CPF_SUPERVISOR,
       FP_FUNCIONARIO_SADE.EST_NOME_SUPERVISOR,
       FP_FUNCIONARIO_SADE.EST_AREA_ATUACAO,
       FP_FUNCIONARIO_SADE.EST_NATUREZA,
       FP_FUNCIONARIO_SADE.EST_NIVEL,
       FP_FUNCIONARIO_SADE.EST_NUMERO_APOLICE,
       (SELECT GE_HELP.CODIGO FROM GE_HELP WHERE GE_HELP.ID = FP_FUNCIONARIO_SADE.RAIS_TIPO_ADM) AS RAIS_TIPO_ADM,
       (SELECT GE_HELP.CODIGO FROM GE_HELP WHERE GE_HELP.ID = FP_FUNCIONARIO_SADE.SEFIP_OCORRENCIA) AS SEFIP_OCORRENCIA,
       FP_FUNCIONARIO_SADE.FUNCIONARIO_FILIADA_SINDICATO,
       FP_FUNCIONARIO_SADE.DATA_OPC_FGTS,
       FP_FUNCIONARIO_SADE.JORNADA_SEMANAL,
       FP_FUNCIONARIO_SADE.SAL_BASE,
       FP_FUNCIONARIO_SADE.CONTA_PAGAMENTO,
       FP_FUNCIONARIO_SADE.DIGITO_CONTA,
       FP_FUNCIONARIO_SADE.ID_AGENCIA,
       GE_PESSOAS.DOCUMENTO,
       GE_PESSOAS.PIS,
       GE_PESSOAS.INSC_INSS,
       GE_PESSOAS.PIS_DATA_CADASTRO,
       GE_PESSOAS.NUMERO_CARTEIRA,
       GE_PESSOAS.SERIE_CARTEIRA,
       GE_PESSOAS.UF_CARTEIRA,
       GE_PESSOAS.CARTEIRA_DATA_EXPEDICAO,
       GE_PESSOAS.TITULO_ELEITOR,
       GE_PESSOAS.TITULO_ZONA,
       GE_PESSOAS.TITULO_SECAO,
       GE_PESSOAS.RG,
       GE_PESSOAS.RG_LOCAL_EMISSAO,
       GE_PESSOAS.RG_DATA_EMISSAO,
       GE_PESSOAS.UF_RG,
       GE_PESSOAS.RESERVISTA,
       GE_PESSOAS.CARTEIRA_HABILITACAO,
       GE_PESSOAS.UF_CNH,
       GE_PESSOAS.CNH_DATA_PRIMEIRA_HABILITACAO,
       GE_PESSOAS.CNH_DATA_EMISSAO,
       GE_PESSOAS.CNH_DATA_VALIDADE,
       GE_PESSOAS.CNH_CATEGORIA,
       GE_PESSOAS.DATA_EXPEDICAO_RNE,
       GE_PESSOAS.NUMERO_RIC,
       GE_PESSOAS.UF_RIC,
       (SELECT SUB.NOME FROM GE_CIDADES AS SUB WHERE GE_PESSOAS.ID_CIDADE_RIC = SUB.ID) AS CIDADE_RIC,
       GE_PESSOAS.EMISSOR_RIC,
       GE_PESSOAS.DATA_EXPEDICAO_RIC,
       FP_FUNCIONARIO_SADE.LIVRO_FOLHA,
       FP_FUNCIONARIO_SADE.NUM_FICHA,
       FP_FUNCIONARIO_SADE.CARTAO_PONTO,
       FP_FUNCIONARIO_SADE.DATA_TRANSFERENCIA,
       FP_FUNCIONARIO_SADE.MATRICULA_ANTERIOR,
       FP_FUNCIONARIO_SADE.CNPJ_EMPREGO_ANTERIOR,
       FP_FUNCIONARIO_SADE.DIAS_CONTR_EXP1,
       FP_FUNCIONARIO_SADE.DIAS_CONTR_EXP2,
       FP_FUNCIONARIO_SADE.ID_CENTRO_CUSTO,
       FP_HORARIOS.CODIGO AS HORARIO_TRABALHO,
       FP_FUNCIONARIO_SADE.ID_SINDICATO,
       FP_FUNCIONARIO_SADE.DATA_DESLIGAMENTO,
       TB_VINCULO.VINCULO,
       TB_VINCULO.CATEGORIA_ESOCIAL
  FROM FP_FUNCIONARIO_SADE
  LEFT JOIN TB_VINCULO
    ON TB_VINCULO.ID_FUNC_SADE = FP_FUNCIONARIO_SADE.ID
  LEFT OUTER JOIN GE_PESSOAS
    ON FP_FUNCIONARIO_SADE.ID_PESSOAS = GE_PESSOAS.ID
  LEFT JOIN FP_HORARIOS
    ON FP_HORARIOS.ID = FP_FUNCIONARIO_SADE.ID_HORARIO_TRABALHO
  LEFT JOIN GE_CIDADES AS ENDERECO
    ON ENDERECO.ID = GE_PESSOAS.ID_CIDADE
  LEFT JOIN GE_CIDADES AS NASCIMENTO
    ON NASCIMENTO.ID = GE_PESSOAS.ID_CIDADE
 ORDER BY 1, 3, 2;