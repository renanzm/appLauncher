WITH FuncDatas AS (
	SELECT OFCODEMP,
		   OFMATFUNC,
		   MIN(OFDTINIOCO) AS PRIMEIRA_DATA,
		   MAX(OFDTINIOCO) AS ULTIMA_DATA
	FROM OCORFUNC
	WHERE OFCODOCORR = '1006'
	GROUP BY OFCODEMP, OFMATFUNC
)
SELECT OC.OFCODEMP,
       OC.OFMATFUNC,
	   OC.OFDTINIOCO,
	   CH.OFCODCGANT AS CARGO_ATUAL
FROM OCORFUNC AS OC
INNER JOIN FuncDatas
	ON OC.OFCODEMP = FuncDatas.OFCODEMP
	AND OC.OFMATFUNC = FuncDatas.OFMATFUNC
	AND OC.OFDTINIOCO = FuncDatas.PRIMEIRA_DATA
OUTER APPLY (
    SELECT TOP 1
        OFCODCGANT
    FROM OCORFUNC CH
    WHERE CH.OFCODEMP = OC.OFCODEMP
      AND CH.OFMATFUNC = OC.OFMATFUNC
	  AND CH.OFCODOCORR = '1006'
      AND CH.OFDTINIOCO > OC.OFDTINIOCO
    ORDER BY CH.OFDTINIOCO
) CH
WHERE OFCODOCORR = '1006'
AND CH.OFCODCGANT IS NOT NULL

UNION

SELECT OCORFUNC.OFCODEMP,
       OCORFUNC.OFMATFUNC,
	   OFDTINIOCO,
	   FUNCIONA.FUCODCARGO AS CARGO_ATUAL
FROM OCORFUNC
INNER JOIN FuncDatas
	ON OCORFUNC.OFCODEMP = FuncDatas.OFCODEMP
	AND OCORFUNC.OFMATFUNC = FuncDatas.OFMATFUNC
	AND OCORFUNC.OFDTINIOCO = FuncDatas.ULTIMA_DATA
INNER JOIN FUNCIONA
	ON OCORFUNC.OFCODEMP = FUNCIONA.FUCODEMP
	AND OCORFUNC.OFMATFUNC = FUNCIONA.FUMATFUNC
WHERE OFCODOCORR = '1006'

UNION

SELECT
    OC.OFCODEMP,
    OC.OFMATFUNC,
    OC.OFDTINIOCO,
    CH.OFCODCGANT AS CARGO_ATUAL
FROM OCORFUNC OC
OUTER APPLY (
    SELECT TOP 1
        OFCODCGANT
    FROM OCORFUNC CH
    WHERE CH.OFCODEMP = OC.OFCODEMP
      AND CH.OFMATFUNC = OC.OFMATFUNC
	  AND CH.OFCODOCORR = '1006'
      AND CH.OFDTINIOCO > OC.OFDTINIOCO
    ORDER BY CH.OFDTINIOCO
) CH
LEFT JOIN FuncDatas AS SUB1
	ON OC.OFCODEMP = SUB1.OFCODEMP
	AND OC.OFMATFUNC = SUB1.OFMATFUNC
	AND OC.OFDTINIOCO = SUB1.PRIMEIRA_DATA
LEFT JOIN FuncDatas AS SUB2
	ON OC.OFCODEMP = SUB2.OFCODEMP
	AND OC.OFMATFUNC = SUB2.OFMATFUNC
	AND OC.OFDTINIOCO = SUB2.ULTIMA_DATA
WHERE OC.OFCODOCORR = '1006'
AND CH.OFCODCGANT IS NOT NULL
AND SUB1.OFCODEMP IS NULL
AND SUB2.OFCODEMP IS NULL
ORDER BY 1, 2, 3
