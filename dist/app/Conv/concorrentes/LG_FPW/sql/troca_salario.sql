WITH SalarioHistorico AS (
    SELECT 
        FUHISTCODEMP,
        FUHISTMATFUNC,
        FUHISTDATAINI,
        FUHISTSALARIO,
        LAG(FUHISTSALARIO) OVER (
            PARTITION BY FUHISTCODEMP, FUHISTMATFUNC 
            ORDER BY FUHISTDATAINI
        ) AS SalarioAnterior
    FROM FUNCIONAHIST
)
SELECT DISTINCT
    SH.FUHISTCODEMP AS FUHISTCODEMP,
    SH.FUHISTMATFUNC AS FUHISTMATFUNC,
    SH.FUHISTDATAINI AS FUHISTDATAINI,
    SH.FUHISTSALARIO AS FUHISTSALARIO,
    OFC.OFNUMPARC,
    TABAUX.TADESITEM
FROM SalarioHistorico SH
LEFT JOIN OCORFUNC OFC 
    ON SH.FUHISTCODEMP = OFC.OFCODEMP
    AND SH.FUHISTMATFUNC = OFC.OFMATFUNC
    AND SH.FUHISTDATAINI = OFC.OFDTINIOCO
    AND SH.FUHISTSALARIO = OFC.OFDTAUX / 100
LEFT JOIN TABAUX
    ON OFC.OFNUMPARC = TABAUX.TACODITEM
    AND TABAUX.TAIDENTTAB = 10003
WHERE SH.SalarioAnterior IS NULL OR SH.SalarioAnterior <> SH.FUHISTSALARIO
 
UNION

SELECT 
    OFCODEMP AS FUHISTCODEMP,
    OFMATFUNC AS FUHISTMATFUNC,
    OFDTINIOCO AS FUHISTDATAINI,
    (OFDTAUX / 100.0) AS FUHISTSALARIO,
    OFNUMPARC,
    TABAUX.TADESITEM
FROM dbo.OCORFUNC
LEFT JOIN TABAUX
    ON OFNUMPARC = TABAUX.TACODITEM
    AND TABAUX.TAIDENTTAB = 10003
WHERE OFCODOCORR IN (1009, 10091, 10092, 10093)

ORDER BY 1,2,3,4 desc