WITH AUTONOMO_EMPRESA AS (
SELECT CD_EMPRESA,
       CD_FILIAL,
       CD_AUTONOMO,
       MIN(DT_LANCAMENTO) AS ADMISSAO
  FROM LANCAUTONOMO
 GROUP BY CD_EMPRESA, CD_FILIAL, CD_AUTONOMO
 ORDER BY 1, 2, 3),
AUTONOMO_SALARIO AS (
SELECT CD_EMPRESA,
       CD_FILIAL,
       CD_AUTONOMO,
       MAX(NR_LANCTO) AS NR_LANCTO
  FROM LANCAUTONOMO
 GROUP BY CD_EMPRESA, CD_FILIAL, CD_AUTONOMO)
SELECT autemp.CD_EMPRESA,
       autemp.CD_FILIAL,
       aut.*,
       autemp.ADMISSAO,
       lanc.VL_LANCAMENTO AS SALARIO,
       mun.CD_MUNICIPIOIBGE,
       est.SG_ESTADO,
       mun_nasc.CD_MUNICIPIOIBGE AS CD_MUNICIPIOIBGE_NASC,
       est_nasc.SG_ESTADO AS SG_ESTADO_NASC,
       gfip.CD_LEGAL AS VINCULO,
       cat.CD_LEGALESOCIAL
  FROM AUTONOMO_EMPRESA autemp
  LEFT JOIN AUTONOMO aut
    ON aut.CD_AUTONOMO = autemp.CD_AUTONOMO
  LEFT JOIN AUTONOMO_SALARIO autsal
    ON autsal.CD_EMPRESA = autemp.CD_EMPRESA
   AND autsal.CD_FILIAL = autemp.CD_FILIAL
   AND autsal.CD_AUTONOMO = autemp.CD_AUTONOMO
  LEFT JOIN LANCAUTONOMO lanc
    ON lanc.CD_EMPRESA = autsal.CD_EMPRESA
   AND lanc.CD_FILIAL = autsal.CD_FILIAL
   AND lanc.CD_AUTONOMO = autsal.CD_AUTONOMO
   AND lanc.NR_LANCTO = autsal.NR_LANCTO
  LEFT JOIN TABCATEGTRAB cat
    ON cat.CD_TABCATEGTRAB = aut.CD_TABCATEGTRAB
  LEFT JOIN CATEGGFIP gfip
    ON gfip.CD_CATEGGFIP = aut.CD_CATEGGFIP
  LEFT JOIN MUNICIPIO mun
    ON mun.CD_MUNICIPIO = aut.CD_MUNICIPIO
  LEFT JOIN MUNICIPIO mun_nasc
    ON mun_nasc.CD_MUNICIPIO = aut.CD_MUNICIPIONASCIMENTO
  LEFT JOIN ESTADO est
    ON est.CD_ESTADO = mun.CD_ESTADO
  LEFT JOIN ESTADO est_nasc
    ON est_nasc.CD_ESTADO = mun_nasc.CD_ESTADO
 ORDER BY 1, 2, 3;