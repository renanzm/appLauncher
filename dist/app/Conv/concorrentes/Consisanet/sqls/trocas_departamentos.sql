WITH PRIMEIRO_LANCAMENTO AS (SELECT CD_EMPRESA,
       CD_EMPREGADO,
       MIN(DT_INICIAL) AS DT_INICIAL,
       CD_DEPARTAMENTO,
       CD_DEPARTAMENTOANT
  FROM HISTORICOPOSICAO
 WHERE CD_DEPARTAMENTOANT IS NOT NULL
 GROUP BY 1, 2, 4, 5
 ORDER BY 1, 2, 3)
SELECT PRIMEIRO_LANCAMENTO.CD_EMPRESA,
       PRIMEIRO_LANCAMENTO.CD_EMPREGADO,
       EMPREGADO.DT_ADMISSAO AS DT_INICIAL,
       CASE
        WHEN PRIMEIRO_LANCAMENTO.DT_INICIAL = EMPREGADO.DT_ADMISSAO THEN PRIMEIRO_LANCAMENTO.CD_DEPARTAMENTO
        ELSE PRIMEIRO_LANCAMENTO.CD_DEPARTAMENTOANT
       END AS CD_DEPARTAMENTO
  FROM PRIMEIRO_LANCAMENTO
  LEFT JOIN EMPREGADO
    ON EMPREGADO.CD_EMPRESA = PRIMEIRO_LANCAMENTO.CD_EMPRESA
   AND EMPREGADO.CD_EMPREGADO = PRIMEIRO_LANCAMENTO.CD_EMPREGADO
UNION
SELECT CD_EMPRESA,
       CD_EMPREGADO,
       DT_INICIAL,
       CD_DEPARTAMENTO
  FROM HISTORICOPOSICAO
 WHERE CD_DEPARTAMENTO IS NOT NULL
 ORDER BY 1, 2, 3;