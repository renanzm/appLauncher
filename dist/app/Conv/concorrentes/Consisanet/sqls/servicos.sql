SELECT cf.CD_EMPRESA,
       cf.CD_FILIAL,
       COALESCE((SELECT DT_INICIOMES 
          FROM CNET_DATAINICIOMES(lt.NR_ANOMESINICIO)), COALESCE(cf.DT_INICIOATIV, cf.DT_CADASTRO) ) AS COMPETECIA,
       cf.TP_REGISTRO,
       cf.DS_FILIAL,
       cf.NR_REGISTRO,
       cf.ST_OBRA,
       cf.NR_CEP,
       cf.DS_ENDERECO,
       cf.NR_ENDERECO,
       cf.DS_COMPLEMENTO,
       cf.DS_BAIRRO,
       cf.NR_TELEFONE,
       (SELECT m.CD_MUNICIPIOIBGE
	      FROM MUNICIPIO m
	     WHERE m.CD_MUNICIPIO = cf.CD_MUNICIPIO) AS MUNICIPIO_IBGE,
       LPAD((SELECT c.CD_SUBCLASSE
               FROM CNAE c
              WHERE c.CD_CNAE = cf.CD_CNAE
                AND c.ST_SITUACAO = 'A'), 7, '0') AS CD_CNAE,
       LPAD(cf.CD_CNAE1, 7, '0') AS CD_CNAE1,
       (SELECT MAX(df.CD_LEGAL)
          FROM DESCRICAOFPAS df
         WHERE df.CD_FPAS = lt.CD_FPAS) AS CODIGO_FPAS,
       (SELECT MAX(tf.CD_LEGAL)
          FROM TABELAFPAS tf
         WHERE tf.CD_FPAS = lt.CD_FPAS
           AND tf.CD_TERCFPAS = lt.CD_TERCFPAS) AS CODIGO_TERCEIRO,
       (SELECT MAX(DISTINCT t.CD_RECOLHIMENTO)
          FROM TOMADOR t
         WHERE (t.NR_INSCRICAOADICIONAL = cf.NR_REGISTRO AND T.TP_INSCRICAO = 'CEI')
            OR (t.NR_INSCRICAO = cf.NR_REGISTRO AND T.TP_INSCRICAO IN ('CNPJ', 'CPF'))) AS CODIGO_GFIP,
       (SELECT MAX(DISTINCT pg.CD_LEGAL)
          FROM CODPGTOGPS pg
         WHERE pg.CD_PGTOGPS = (SELECT MAX(t.CD_PGTOGPS)
                                  FROM TOMADOR t
                                 WHERE (t.NR_INSCRICAOADICIONAL = cf.NR_REGISTRO AND T.TP_INSCRICAO = 'CEI')
                                    OR (t.NR_INSCRICAO = cf.NR_REGISTRO AND T.TP_INSCRICAO IN ('CNPJ')))) AS CODIGO_GPS,
       (SELECT MAX(DISTINCT pg.CD_LEGAL) 
          FROM CODPGTOGPS pg
         WHERE pg.CD_PGTOGPS = (SELECT MAX(fp.CD_PGTOPRINCGPS)
                                  FROM FILENQPERIODO fp
                                 WHERE (fp.CD_EMPRESA = cf.CD_EMPRESA AND fp.CD_FILIAL = cf.CD_FILIAL))) AS CODIGO_GPS2,
       lt.CD_LOTACAO AS CODIGO_ESOCIAL
  FROM LOTACAOTRIBUTARIA lt
 RIGHT OUTER JOIN CADFILFOLHAATRIB cf
    ON lt.CD_EMPRESA = cf.CD_EMPRESA
   AND lt.CD_FILIAL = cf.CD_FILIAL
 ORDER BY CD_EMPRESA, CD_FILIAL;