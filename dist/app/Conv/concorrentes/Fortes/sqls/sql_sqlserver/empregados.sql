SELECT EPG.EMP_CODIGO,
	EPG.CODIGO,
	EPG.NOME,
	EPG.DTNASCIMENTO,
	EPG.NACIONALIDADE,
	EPG.ANOCHEGADA,
	EPG.TIPOVISTO,
	EPG.DTVALIDADERG,
	EPG.DTVALIDADECTPS,
	EPG.MUN_UFD_SIGLA_NATURALIDADE,
	EPG.MUN_CODIGO_NATURALIDADE,
	EPG.GRAUINSTRUCAO,
	EPG.RACACOR,
	EPG.SEXO,
	EPG.MAENOME,
	EPG.PAINOME,
	EPG.ESTADOCIVIL,
	EPG.CONJUGENOME,
	EPG.CONJUGECPF,
	EPG.CONJUGEDTNASCIMENTO,
	EPG.CONTACORRENTE,
	EPG.AGE_BAN_CODIGO,
	EPG.AGE_CODIGO,
	EPG.CONTACORRENTENUMERO,
	EPG.CONTASALARIO,
	EPG.DDD,
	EPG.FONE,
	EPG.CELULAR,
	EPG.EMAIL,
	EPG.ENDLOGRADOURO,
	EPG.ENDNUMERO,
	EPG.ENDCOMPLEMENTO,
	EPG.BAIRRO,
	EPG.CEP,
	EPG.MUN_UFD_SIGLA,
	EPG.MUN_CODIGO,
	EPG.CTPSSERIE,
	EPG.CTPSDV,
	EPG.UFD_SIGLA_CTPS,
	EPG.CTPSDTEXPEDICAO,
	EPG.PIS,
	EPG.CPF,
	EPG.TITULO,
	EPG.ZONA,
	EPG.SECAO,
	EPG.IDENTIDADENUMERO,
	EPG.IDENTIDADEORGAOEXPEDIDOR,
	EPG.IDENTIDADEDTEXPEDICAO,
	EPG.REGISTROLIVRO,
	EPG.REGISTRONUMERO,
	EPG.ADMISSAODATA,
	EPG.ADMISSAOTIPO,
	EPG.ADMISSAONATUREZA,
	EPG.ADMISSAOVINCULO,
	EPG.FGTS,
	EPG.FGTSDTOPCAO,
	EPG.FGTSCODCEF,
	EPG.EXAMEMEDICODTULTIMO,
	EPG.EXAMEMEDICOVALIDADE,
	EPG.FERIASDTPREVISAO,
	EPG.DTRESCISAO,
	EPG.ANOCTRSINDICAL,
	EPG.DEFICIENTEFISICO,
	EPG.CATEGORIA,
	EPG.CIPA,
	EPG.DTAPOSENTADORIA,
	EPG.HABILITACAONUMERO,
	EPG.HABILITACAOEMISSAO,
	EPG.HABILITACAOVENCIMENTO,
	EPG.HABILITACAOCATEGORIA,
	EPG.PARTICIPAPAT,
	EPG.ALVARA,
	EPG.DTTRANSFERENCIA,
	EPG.CMTIPO,
	EPG.CMNUMERO,
	EPG.CMSERIE,
	EPG.CMCATEGORIA,
	EPG.CMCSM_OAM,
	EPG.CMRM_DN_COMAR,
	EPG.EXPRADIACAO,
	EPG.TIPOSANGUINEO,
	EPG.FATORRH,
	EPG.CTPSNUMERO,
	EPG.SENHAWEB,
	EPG.MUN_UFD_SIGLA_IDENTORGAOEXPED,
	EPG.DTFALECIMENTO,
	EPG.DTEXONERACAO,
	EPG.SALARIOCONTRATUAL,
	EPG.ANO1EMPREGO,
	EPG.NOMECOMERCIAL,
	EPG.HORARIOPONTO,
	EPG.CLAUSULAASSECURATORIA,
	EPG.VIN_ID,
	EPG.QUALIFICACAOSTATUS,
	EPG.SITUACAOSEGURODESEMPREGO,
	EPG.DATAGERACAOCAGED,
	EPG.STATUSCAGED,
	EPG.NACIONALIDADE_NIS,
	EPG.QUALIFICADO,
	EPG.MENSAGEMQUALIFICACAO,
	EPG.PAISNASCIMENTO,
	EPG.PAISNACIONALIDADE,
	EPG.TEMDEFICIENCIA,
	EPG.DEFICIENCIAFISICA,
	EPG.DEFICIENCIAVISUAL,
	EPG.DEFICIENCIAAUDITIVA,
	EPG.DEFICIENCIAMENTAL,
	EPG.DEFICIENCIAINTELECTUAL,
	EPG.DEFICIENCIAREABILITADO,
	EPG.DEFICIENCIAOBSERVACOES,
	EPG.ESTRANGEIRODTCHEGADA,
	EPG.ESTRANGEIROCLASSIFICACAO,
	EPG.ESTRANGEIROCASADOBR,
	EPG.ESTRANGEIROFILHOSBR,
	EPG.PAISRESIDENCIA,
	EPG.EXTERIORCIDADE,
	EPG.EXTERIORLOGRADOURO,
	EPG.EXTERIORNUMERO,
	EPG.EXTERIORCOMPLEMENTO,
	EPG.EXTERIORBAIRRO,
	EPG.EXTERIORCODIGOPOSTAL,
	EPG.TEMHABILITACAO,
	EPG.TEMRIC,
	EPG.RICNUMERO,
	EPG.RICORGAOEXPEDIDOR,
	EPG.RICDTEXPEDICAO,
	EPG.RNENUMERO,
	EPG.RNEORGAOEXPEDIDOR,
	EPG.RNEDTEXPEDICAO,
	EPG.TEMORGAOCLASSE,
	EPG.ORGAOCLASSENUMERO,
	EPG.ORGAOCLASSEORGAOEXPEDIDOR,
	EPG.ORGAOCLASSEDTEXPEDICAO,
	EPG.ORGAOCLASSEDTVALIDADE,
	EPG.ADMISSAOINDICATIVO,
	EPG.ADMISSAOTIPOESOCIAL,
	EPG.EMAILALTERNATIVO,
	EPG.HABILITACAODATAPRIMEIRA,
	EPG.HABILITACAOUF,
	EPG.ID_EXTERNO,
	EPG.ALVARA_PAJ_CODIGO,
	EPG.HIPOTESELEGALTRABTEMP,
	EPG.JUSTIFICATIVATRABTEMP,
	EPG.INCLUSAOCONTRATOTRABTEMP,
	EPG.NOMESOCIAL,
	EPG.DDDALTERNATIVO,
	EPG.PREENCHECOTADEFICIENCIA,
	EPG.INDICATIVOPROVIMENTO,
	EPG.TIPOPROVIMENTO,
	EPG.DATANOMEACAO,
	EPG.DATAPOSSE,
	EPG.DATAEXERCICIO,
	EPG.PROCJUD_PAJ_CODIGO,
	EPG.CNPJEMPREGADORANTERIOR,
	EPG.MATRICULAANTERIOR,
	EPG.OBSERVACAOVINCULOANTERIOR,
	EPG.CATEGORIGSINDICAL,
	EPG.CNPJORIGSINDICAL,
	EPG.DTADMORIGSINDICAL,
	EPG.MATRICORIGSINDICAL,
	EPG.CATEGORIGCEDIDO,
	EPG.CNPJORIGCEDIDO,
	EPG.MATRICORIGCEDIDO,
	EPG.DTADMCEDIDO,
	EPG.TIPREGIMTRABCEDIDO,
	EPG.TIPREGIMPREVCEDIDO,
	EPG.ONUSCEDIDO,
	EPG.CNPJCPFEMPCONTRATANTETRABTEMP,
	EPG.CNPJCPFESTCONTRATANTETRABTEMP,
	EPG.CPFTRABALHADORSUBSTTRABTEMP,
	EPG.ID_CEPG,
	EPG.ACAO,
	EPG.STATUS,
	EPG.CODIGO_EVENTO,
	EPG.CNPJCPFEMPMENORAPREN,
	EPG.DTINIAFASTANTERIOR,
	EPG.TLI_CODIGOAFASTANTERIOR,
	EPG.EXCLUISOMENTEESOCIAL,
	EPG.CNPJSUCESSORA,
	EPG.ORGAOCLASSEUF,
	EPG.RICUF,
	EPG.RNEUF,
	EPG.CODMOTIVODESLIGTSV,
	EPG.MATRICULAESOCIAL,
	EPG.TPINSCANT,
	EPG.NUMEROALVARA,
	(SELECT TOP 1 INSCRICAO
	 FROM EEA
	 WHERE CODIGO = (
		 SELECT TOP 1 EEA_CODIGO_EFETIVACAO
		 FROM SEP
		 WHERE EPG.EMP_CODIGO = SEP.EMP_CODIGO
		   AND EPG.CODIGO = SEP.EPG_CODIGO
		 ORDER BY SEP.DATA DESC
	 )) AS INSCRICAO_EFETIVACAO,
	(SELECT TOP 1 INSCRICAO
	 FROM EEA
	 WHERE CODIGO = (
		 SELECT TOP 1 EEA_CODIGO_PRATICA
		 FROM SEP
		 WHERE EPG.EMP_CODIGO = SEP.EMP_CODIGO
		   AND EPG.CODIGO = SEP.EPG_CODIGO
		 ORDER BY SEP.DATA DESC
	 )) AS INSCRICAO_PRATICA,
	(SELECT TOP 1 INDCONTRATAAPRENDIZ
	 FROM SEP
	 WHERE EPG.EMP_CODIGO = SEP.EMP_CODIGO
	   AND EPG.CODIGO = SEP.EPG_CODIGO
	 ORDER BY SEP.DATA DESC),
	(SELECT MUN.NOME FROM MUN WHERE MUN.CODIGO = EPG.MUN_Codigo AND MUN.UFD_SIGLA = EPG.MUN_UFD_SIGLA) AS END_CIDADE,
	(SELECT MUN.NOME FROM MUN WHERE MUN.CODIGO = EPG.MUN_Codigo_Naturalidade AND MUN.UFD_SIGLA = EPG.MUN_UFD_SIGLA_NATURALIDADE) AS NATU_CIDADE,
	SEP_Antigo.CAR_CODIGO AS CARGO,
    SEP_Recente.EST_CODIGO AS SERVICO,
    SEP_Antigo.HOR_CODIGO AS HORARIO,
    SEP_Antigo.LOT_CODIGO AS DEPARTAMENTO,
    SEP_Recente.SIN_CODIGO AS SINDICATO,
    SEP_Antigo.TOM_CODIGO AS TOMADOR,
	SEP_Recente.FUN_CODIGO AS FUN_CODIGO,
	SEP_Recente.EXPAGENOCIV AS OCORRENCIA_SEFIP,
	SEP_Recente.HORASMES AS HORASMES,
	SEP_Recente.HORASSEMANA AS HORASSEMANA,
	SEP_Recente.CATEGORIAESOCIAL AS CATEG_ESOCIAL,
	(SELECT MAX(DTFINAL) FROM PAE WHERE PAE.EMP_CODIGO = EPG.EMP_CODIGO AND PAE.EPG_CODIGO = EPG.CODIGO) as PERIODO_AQUISITIVO_FIM,
	CASE (SELECT MIN(SEP.SalTipo) 
	FROM SEP 
	WHERE EPG.EMP_CODIGO = SEP.EMP_CODIGO 
	AND EPG.CODIGO = SEP.EPG_CODIGO 
	AND SEP.DATA >= (SELECT MIN(SEP.DATA) 
					FROM SEP 
					WHERE EPG.EMP_CODIGO = SEP.EMP_CODIGO 
					AND EPG.CODIGO = SEP.EPG_CODIGO))
	WHEN 'I' THEN COALESCE((SELECT VID.valor 
							FROM VID, SEP 
							WHERE VID.IND_CODIGO = SEP.IND_CODIGO_SALARIO 
							AND SEP.EMP_CODIGO = EPG.EMP_CODIGO
							AND EPG.CODIGO = SEP.EPG_CODIGO
							AND SEP.DATA = (SELECT MAX(S.DATA) FROM SEP S WHERE EPG.EMP_CODIGO = S.EMP_CODIGO AND EPG.CODIGO = S.EPG_CODIGO AND S.SALTIPO = 'I')
							AND VID.DATA = (SELECT MAX(V.DATA) 
							FROM VID V 
							WHERE V.IND_CODIGO = VID.IND_CODIGO 
							AND V.DATA <= EPG.ADMISSAODATA)),0)
	ELSE COALESCE((SELECT MIN(SEP.VALOR) FROM SEP WHERE EPG.EMP_CODIGO = SEP.EMP_CODIGO AND EPG.CODIGO = SEP.EPG_CODIGO AND SEP.DATA <= (SELECT MIN(SEP.DATA) FROM SEP WHERE EPG.EMP_CODIGO = SEP.EMP_CODIGO AND EPG.CODIGO = SEP.EPG_CODIGO)),0) END AS SALARIO,
	(SELECT SEP.Data FROM SEP WHERE EPG.EMP_CODIGO = SEP.EMP_CODIGO AND EPG.CODIGO = SEP.EPG_CODIGO AND SEP.DATA <= (SELECT MIN(SEP.DATA) FROM SEP WHERE EPG.EMP_CODIGO = SEP.EMP_CODIGO AND EPG.CODIGO = SEP.EPG_CODIGO)) AS Data_alteracao,
	SEP_Recente.IndQtde,
	SEP_Recente.IND_Codigo_Salario,
	SEP_Antigo.SalTipo,
	SEP_Recente.QTDDIASPRAZO,
	SEP_Recente.QTDDIASPRAZOPRORROGACAO,
	SEP_Recente.EDU_CODIGO,
	SEP_Recente.AIN_CODIGO,
	SEP_Recente.NOMESUPERVISORESTAGIO,
	SEP_Recente.CPFSUPERVISORESTAGIO,
	SEP_Antigo.TIPOSALARIO,
	SEP_Recente.AREAESTAGIO,
	SEP_Recente.NATUREZAESTAGIO,
	SEP_Recente.NIVELESTAGIO,
	SEP_Recente.NUMEROAPOLICE,
	SEP_Recente.PERCENTUALADIANT
FROM EPG
LEFT JOIN 
    (SELECT 
         EMP_CODIGO,
         EPG_CODIGO,
         MIN(DATA) AS DATA_MINIMA,
         MAX(DATA) AS DATA_MAXIMA
     FROM SEP
     GROUP BY EMP_CODIGO, EPG_CODIGO) AS SEP_Fechas ON EPG.EMP_CODIGO = SEP_Fechas.EMP_CODIGO AND EPG.CODIGO = SEP_Fechas.EPG_CODIGO
LEFT JOIN SEP AS SEP_Antigo
	ON SEP_Antigo.EMP_CODIGO = SEP_Fechas.EMP_CODIGO
	AND SEP_Antigo.EPG_CODIGO = SEP_Fechas.EPG_CODIGO
	AND SEP_Antigo.DATA = SEP_Fechas.DATA_MINIMA
LEFT JOIN SEP AS SEP_Recente
	ON SEP_Recente.EMP_CODIGO = SEP_Fechas.EMP_CODIGO
	AND SEP_Recente.EPG_CODIGO = SEP_Fechas.EPG_CODIGO
	AND SEP_Recente.DATA = SEP_Fechas.DATA_MAXIMA
ORDER BY 1, 2;