SELECT EMP.CODIGO,
	EST.CODIGO as cod_filial,
	EMP.MODELO,
	EST.NOME,
	EMP.RAZAOSOCIAL,
	EMP.NMFANTASIA,
	EMP.CNPJBASE,
	EST.SEQCNPJ,
	EMP.CPF,
	EST.CEI,
	EMP.DTINIATIV,
	EMP.DESATIVADA,	
	EST.ENDLOGRADOURO,
	EST.ENDNUMERO,
	EST.ENDCOMPLEMENTO,
	EST.BAIRRO,
	EST.CEP,
	EST.MUN_UFD_SIGLA,
	EST.MUN_CODIGO,
	(SELECT max(MUN.NOME) FROM MUN WHERE MUN.CODIGO = EST.MUN_CODIGO AND MUN.UFD_SIGLA = EST.MUN_UFD_SIGLA AND EMP.CODIGO = EST.EMP_CODIGO) AS CIDADE,
	EST.IE,
	EST.IM,
	EST.EMAIL,
	EST.DDD,
	EST.FONE,
	EST.FAX,
	EST.FPAS,
	EST.CNAE_FISCAL,
	EST.DTENCERRAMENTO,
	EST.ALIQUOTASAT,
	EST.CODIGOTERCEIROS,
	EST.CODIGOGPS,
	EST.INSSALIQTERCEIROS,
	EST.NATUREZAJURIDICA,
	EST.INSSALIQCONTRIB,
	EST.CNAE2_CODIGO,
	EST.ESOCIAL,
	(SELECT max(HES.CNAE2_CODIGO) FROM HES WHERE HES.EST_CODIGO = EST.CODIGO AND HES.EMP_CODIGO = EMP.CODIGO) AS CNAE2,
	(SELECT HES.SIP_CODIGO 
	   FROM HES 
	  WHERE HES.EMP_CODIGO = EMP.CODIGO 
	    AND HES.EST_CODIGO = EST.CODIGO 
	    AND HES.DATA = (SELECT MAX(SUB.DATA) 
	                      FROM HES AS SUB 
	                     WHERE SUB.EMP_CODIGO = HES.EMP_CODIGO
	                       AND SUB.EST_CODIGO = HES.EST_CODIGO)) as SIND_PATRONAL
FROM EMP LEFT JOIN EST ON EMP.CODIGO = EST.EMP_CODIGO
WHERE EST.CODIGO IS NOT NULL AND EST.CODIGO != ''
ORDER BY EMP.CODIGO, SEQCNPJ, EST.CODIGO