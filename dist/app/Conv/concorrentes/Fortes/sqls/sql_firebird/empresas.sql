SELECT EMP.CODIGO,
	EST.CODIGO AS COD_FILIAL,
	EMP.MODELO,
	EST.NOME,
	EMP.RAZAOSOCIAL,
	EMP.NMFANTASIA,
	EMP.CNPJBASE,
	EST.SEQCNPJ,
	EMP.CPF,
	EST.CEI,
	EST.MATRIZ,
	EMP.DESATIVADA,	
	EST.ENDLOGRADOURO,
	EST.ENDNUMERO,
	EST.ENDCOMPLEMENTO,
	EST.BAIRRO,
	EST.CEP,
	EST.MUN_UFD_SIGLA,
	EST.MUN_CODIGO,
	(SELECT MUN.NOME FROM MUN WHERE MUN.CODIGO = EST.MUN_CODIGO AND MUN.UFD_SIGLA = EST.MUN_UFD_SIGLA) AS CIDADE,
	EST.IE,
	EST.IM,
	EST.SUFRAMA,
	EST.EMAIL,
	EST.DDD,
	EST.FONE,
	EST.FAX,
	EST.FPAS,
	EST.CNAE_FISCAL,
	EST.DTENCERRAMENTO,
	EST.ALIQUOTASAT,
	EST.CODIGOTERCEIROS,
	EST.CODIGOGPS,
	EST.CTA_CODIGO,
	EST.INSSALIQTERCEIROS,
	(SELECT HES.NATUREZAJURIDICA 
	   FROM HES 
	  WHERE HES.EMP_CODIGO = EMP.CODIGO 
	    AND HES.EST_CODIGO = EST.CODIGO 
	    AND HES.DATA = (SELECT MAX(SUB.DATA) 
	                      FROM HES AS SUB 
	                     WHERE SUB.EMP_CODIGO = HES.EMP_CODIGO
	                       AND SUB.EST_CODIGO = HES.EST_CODIGO)) AS NATUREZAJURIDICA,
	EST.INSSALIQCONTRIB,
	EST.DTINIATIV AS EST_DTINIATIV,
	EMP.DTINIATIV AS EMP_DTINIATIV,
	(SELECT MIN(HES.DATA) FROM HES WHERE HES.EMP_CODIGO = EMP.CODIGO) AS SERVIG_DTINIATIV,
	(SELECT MIN(EPG.ADMISSAODATA) FROM EPG WHERE EPG.EMP_CODIGO = EMP.CODIGO) AS FUNC_DTINIATIV,
	EST.CNAE2_CODIGO,
	(SELECT MAX(HES.CNAE2_CODIGO) FROM HES WHERE HES.EST_CODIGO = EST.CODIGO AND HES.EMP_CODIGO = EMP.CODIGO) AS CNAE2
FROM EMP LEFT JOIN EST ON EMP.CODIGO = EST.EMP_CODIGO
ORDER BY EMP.CODIGO, SEQCNPJ, EST.CODIGO
