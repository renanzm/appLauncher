WITH AUTONOMO_EMP AS (
SELECT emp.BDCODEMP,
       emp.BDCODTER,
       MIN(emp.BDREFSERV) AS BDREFSERV
  FROM VRH_BASE_TSERVTERC emp
 GROUP BY 1, 2
),
VINCULOS AS (
SELECT BDCODTER,
       BDREFTERC AS BDREFTERC,
       BDCATEGORIATER,
       BDCATEGORIAESOCIAL
  FROM VRHF_BASE_TTERC_FGTSGPS A
 WHERE A.BDREFTERC = (SELECT MAX(BDREFTERC) 
                        FROM VRHF_BASE_TTERC_FGTSGPS B
                       WHERE B.BDCODTER = A.BDCODTER)
)
SELECT EMP.BDCODEMP,
       TER.BDCODTER,
       TER.BDNOMTER,
       TER.BDCODCID,
       TER.BDLOGRTER,
       TER.BDENDTER,
       TER.BDNUMTER,
       TER.BDCOMPLTER,
       TER.BDBAITER,
       TER.BDCEPTER,
       TER.BDDDDTER,
       TER.BDFONETER,
       TER.BDCELTER,
       TER.BDEMAILTER,
       TER.BDDATANASCTER,
       TER.BDCODCIDNASCTER,
       (SELECT MAX(TER_REF.BDCGCTER) FROM TTERCEIRO_REF AS TER_REF WHERE TER_REF.BDCODTER = TER.BDCODTER) AS CPF,
       (SELECT MAX(C.BDNOMCID) FROM TCIDADE AS C WHERE C.BDCODCID = TER.BDCODCID) AS CIDADE,
       (SELECT MAX(UF.BDSIGLAUF) FROM TCIDADE AS C, TUF AS UF WHERE C.BDCODCID = TER.BDCODCID AND C.BDCODUF = UF.BDCODUF) AS ESTADO,
       (SELECT MAX(C.BDNOMCID) FROM TCIDADE AS C WHERE C.BDCODCID = TER.BDCODCIDNASCTER) AS CIDADE_NASC,
       (SELECT MAX(UF.BDSIGLAUF) FROM TCIDADE AS C, TUF AS UF WHERE C.BDCODCID = TER.BDCODCIDNASCTER AND C.BDCODUF = UF.BDCODUF) AS ESTADO_NASC,
       TER.BDDATACADTER,
       TER.BDDDDCELTER,
       TER.BDSEXOTER,
       VIN.BDCATEGORIATER,
       VIN.BDCATEGORIAESOCIAL
  FROM AUTONOMO_EMP EMP
 INNER JOIN VW_VRH_BASE_TTERC TER
    ON TER.BDCODTER = EMP.BDCODTER
  LEFT JOIN VINCULOS VIN
    ON VIN.BDCODTER = EMP.BDCODTER
 ORDER BY 1, 2