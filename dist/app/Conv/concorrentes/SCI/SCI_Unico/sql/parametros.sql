WITH MAX_DATE_REG AS (
	SELECT BDCODEMP, MAX(BDREFEMP) AS BDREFEMP
	FROM TENQFED
	GROUP BY BDCODEMP
),
MAX_DATE_ANEXO AS (
	SELECT BDCODEMP, MAX(BDREFEMP) AS BDREFEMP
	FROM VEF_BASE_TEMPITEMSATV
	GROUP BY BDCODEMP
)
SELECT ENQFED.BDCODEMP,
	   REPLACE(vet.BDGRUPO, 0, 5) AS BDGRUPO,
       ENQFED.BDCODENQFED,
       ANEXO.BDANEXOIII,
       ANEXO.BDANEXOIV,
       ANEXO.BDANEXOV
FROM VRH_ESOCIAL_TFASEAMENTO vet
LEFT JOIN MAX_DATE_REG
	ON MAX_DATE_REG.BDCODEMP = vet.BDCODEMP
LEFT JOIN TENQFED AS ENQFED
	ON ENQFED.BDCODEMP = MAX_DATE_REG.BDCODEMP
	AND ENQFED.BDREFEMP = MAX_DATE_REG.BDREFEMP
LEFT JOIN MAX_DATE_ANEXO
	ON MAX_DATE_ANEXO.BDCODEMP = vet.BDCODEMP
LEFT JOIN VEF_BASE_TEMPITEMSATV AS ANEXO
	ON ANEXO.BDCODEMP = MAX_DATE_ANEXO.BDCODEMP
	AND ANEXO.BDREFEMP = MAX_DATE_ANEXO.BDREFEMP
ORDER BY 1