WITH ULTIMO_AQUISITIVO AS (
	SELECT ID_FUNCIONARIO,
	       MAX(INICIO_PER_AQUIS) AS INICIO_PER_AQUIS
	FROM FO_FUNCIONARIOS_FERIAS
	WHERE SITUACAO != 1
	GROUP BY ID_FUNCIONARIO
)
SELECT FO_FUNCIONARIOS.*,
       MUN_ENDERECO.COD_IBGE AS IBGE_ENDERECO,
       MUN_NASCIMENTO.COD_IBGE AS IBGE_NASCIMENTO,
       FO_TRANSFERENCIA."DATA" AS DATA_TRANSF,
       FO_TRANSFERENCIA.ID_FILIALORIGEM,
       FO_TRANSFERENCIA.ID_FUNCORIGEM,
       ULTIMO_AQUISITIVO.INICIO_PER_AQUIS
FROM FO_FUNCIONARIOS
LEFT JOIN MUNICIPIOS AS MUN_ENDERECO
	ON MUN_ENDERECO.CMUCOD = FO_FUNCIONARIOS.FUNCMUCOD
LEFT JOIN MUNICIPIOS AS MUN_NASCIMENTO
	ON MUN_NASCIMENTO.CMUCOD = FO_FUNCIONARIOS.FUNCMUCOD
LEFT JOIN FO_TRANSFERENCIA
	ON FO_TRANSFERENCIA.ID_FUNCDESTINO = FO_FUNCIONARIOS.ID_FUNCIONARIO
LEFT JOIN ULTIMO_AQUISITIVO
	ON ULTIMO_AQUISITIVO.ID_FUNCIONARIO = FO_FUNCIONARIOS.ID_FUNCIONARIO
ORDER BY 2, 1