WITH ULTIMA_VIGENCIA AS (
	SELECT SUB.ESTABELECIMENTO,
	       MAX(SUB.VIGENCIA) AS VIGENCIA
	FROM TRIBUTACAO_FOLHA AS SUB
	GROUP BY SUB.ESTABELECIMENTO
)
SELECT ESTABELECIMENTOS.*,
	   EMPRESAS.CONTADOR,
       TRIBUTACAO_FOLHA.CODIGO_FPAS,
       TRIBUTACAO_FOLHA.CODIGO_GPS,
       TRIBUTACAO_FOLHA.TERCEIROS_CODIGO,
       TRIBUTACAO_FOLHA.INSS_EMPREGADOS,
       TRIBUTACAO_FOLHA.TERCEIROS_ALIQUOTA,
       TRIBUTACAO_FOLHA.RAT_ALIQUOTA
FROM ESTABELECIMENTOS
LEFT JOIN EMPRESAS
	ON EMPRESAS.EMPRESA = ESTABELECIMENTOS.EMPRESA
LEFT JOIN ULTIMA_VIGENCIA
	ON ULTIMA_VIGENCIA.ESTABELECIMENTO = ESTABELECIMENTOS.ESTABELECIMENTO
LEFT JOIN TRIBUTACAO_FOLHA
	ON TRIBUTACAO_FOLHA.ESTABELECIMENTO = ULTIMA_VIGENCIA.ESTABELECIMENTO
	AND TRIBUTACAO_FOLHA.VIGENCIA = ULTIMA_VIGENCIA.VIGENCIA
	AND TRIBUTACAO_FOLHA.TOMADOR IS NULL
ORDER BY ESTABELECIMENTOS.EMPRESA, ESTABELECIMENTOS.ESTABELECIMENTO