WITH PERIODOS AS (
	SELECT PERIODOS_UTILIZADOS.CONTRATO,
	   	   PERIODOS_UTILIZADOS.PERIODO
	FROM PERIODOS_UTILIZADOS
	WHERE PERIODOS_UTILIZADOS.FERIAS IS NOT NULL
	ORDER BY CONTRATO, CHAVE
)
SELECT PERIODOS_AQUISITIVOS.CONTRATO,
       MAX(PERIODOS_AQUISITIVOS.DATA_FINAL) AS DATA_FINAL
FROM PERIODOS_AQUISITIVOS
INNER JOIN PERIODOS
	ON PERIODOS.CONTRATO = PERIODOS_AQUISITIVOS.CONTRATO
	AND PERIODOS.PERIODO = PERIODOS_AQUISITIVOS.PERIODO
GROUP BY 1
ORDER BY 1, 2 DESC
