WITH VIGENCIA AS (SELECT ESTABELECIMENTO,
                         CONTRATO,
                         DEPENDENTE,
                         PLANO,
                         MIN("DATA") AS "DATA"
                    FROM VALORES_PAGOS_DO_PLANO
                   GROUP BY ESTABELECIMENTO,
                            CONTRATO,
                            DEPENDENTE,
                            PLANO)
SELECT CONTRATOS.ESTABELECIMENTO,
       CONTRATOS.CONTRATO,
       PLANOS_DO_CONTRATO.PLANO,
       COALESCE(
         VIGENCIA."DATA",
         COALESCE(DEPENDENTES.NASCIMENTO, CONTRATOS.ADMISSAO_DATA)
       ) AS "DATA",
       PLANOS_DO_CONTRATO.DEPENDENTE,
       PLANOS_DO_CONTRATO.VALOR
  FROM PLANOS_DO_CONTRATO
  LEFT JOIN CONTRATOS
    ON CONTRATOS.CONTRATO = PLANOS_DO_CONTRATO.CONTRATO
  LEFT JOIN DEPENDENTES
    ON DEPENDENTES.DEPENDENTE = PLANOS_DO_CONTRATO.DEPENDENTE
  LEFT JOIN VIGENCIA
    ON VIGENCIA.ESTABELECIMENTO = CONTRATOS.ESTABELECIMENTO
   AND VIGENCIA.CONTRATO = PLANOS_DO_CONTRATO.CONTRATO
   AND VIGENCIA.DEPENDENTE = PLANOS_DO_CONTRATO.DEPENDENTE
   AND VIGENCIA.PLANO = PLANOS_DO_CONTRATO.PLANO
 ORDER BY 1, 2;