WITH TRANSFERENCIAS AS (
	SELECT CONTRATO_ATUAL.ESTABELECIMENTO,
    	   CONTRATO_ATUAL.CONTRATO,
       	   CONTRATO_ANTERIOR.MATRICULA AS MATRICULA_ORIGEM,
       	   ESTABELECIMENTOS.CNPJ AS INSCRICAO_FILIAL_ORIGEM
	FROM CONTRATOS AS CONTRATO_ATUAL
	INNER JOIN CONTRATOS AS CONTRATO_ANTERIOR
		ON CONTRATO_ANTERIOR.CONTRATO = CONTRATO_ATUAL.VINCULO_ANTERIOR
	INNER JOIN ESTABELECIMENTOS
		ON ESTABELECIMENTOS.ESTABELECIMENTO = CONTRATO_ANTERIOR.ESTABELECIMENTO
	WHERE CONTRATO_ATUAL.DATA_TRANSFERENCIA IS NOT NULL
	ORDER BY 1, 2
)
SELECT CONTRATOS.*,
       PESSOAS.*,
       TRANSFERENCIAS.MATRICULA_ORIGEM,
       TRANSFERENCIAS.INSCRICAO_FILIAL_ORIGEM
FROM CONTRATOS
LEFT JOIN PESSOAS
	ON PESSOAS.PESSOA = CONTRATOS.PESSOA
LEFT JOIN TRANSFERENCIAS
	ON TRANSFERENCIAS.ESTABELECIMENTO = CONTRATOS.ESTABELECIMENTO
	AND TRANSFERENCIAS.CONTRATO = CONTRATOS.CONTRATO
ORDER BY ESTABELECIMENTO, CONTRATO
